name: CI

on:
  push:
    branches: [main]
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  ci:
    name: Build & Check
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 25 (for toolchain)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "25"

      - name: Set up JDK 21 (default)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}
          add-job-summary: always

      - name: Setup wgpu4k
        uses: ./.github/actions/setup-wgpu4k

      - name: Check formatting & static analysis
        run: |
          START=$SECONDS
          ./gradlew ktfmtCheck detektMetadataCommonMain detektJvmMain --configuration-cache-problems=warn || EXIT=$?
          echo "### Lint & Analysis: $((SECONDS - START))s" >> "$GITHUB_STEP_SUMMARY"
          exit ${EXIT:-0}

      - name: Compile & test
        run: |
          START=$SECONDS
          ./gradlew jvmTest --configuration-cache-problems=warn || EXIT=$?
          echo "### Compile & Test: $((SECONDS - START))s" >> "$GITHUB_STEP_SUMMARY"
          exit ${EXIT:-0}

      - name: Gradle build cache diagnostics
        if: always()
        run: |
          echo "### Gradle Build Cache" >> "$GITHUB_STEP_SUMMARY"
          CACHE_DIR=~/.gradle/caches/build-cache-1
          if [ -d "$CACHE_DIR" ]; then
            ENTRY_COUNT=$(find "$CACHE_DIR" -type f | wc -l)
            CACHE_SIZE=$(du -sh "$CACHE_DIR" | cut -f1)
            echo "| Metric | Value |" >> "$GITHUB_STEP_SUMMARY"
            echo "|--------|-------|" >> "$GITHUB_STEP_SUMMARY"
            echo "| Entries | ${ENTRY_COUNT} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| Size | ${CACHE_SIZE} |" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "No local build cache directory found." >> "$GITHUB_STEP_SUMMARY"
          fi

  apple:
    name: Apple Targets
    runs-on: macos-15
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 25 (for toolchain)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "25"

      - name: Set up JDK 21 (default)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}
          add-job-summary: always

      - name: Get Kotlin version
        id: kotlin-version
        run: |
          KOTLIN=$(grep '^kotlin ' gradle/libs.versions.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          if [ -z "$KOTLIN" ]; then
            echo "::error::Failed to extract Kotlin version from libs.versions.toml"
            exit 1
          fi
          echo "version=$KOTLIN" >> "$GITHUB_OUTPUT"

      - name: Cache Kotlin/Native toolchain
        uses: actions/cache@v4
        with:
          path: ~/.konan
          key: ${{ runner.os }}-konan-${{ steps.kotlin-version.outputs.version }}

      - name: Setup wgpu4k
        uses: ./.github/actions/setup-wgpu4k
        with:
          rust-targets: aarch64-apple-ios,aarch64-apple-ios-sim

      - name: Apple native tests + XCFramework
        run: |
          START=$SECONDS
          ./gradlew macosArm64Test iosSimulatorArm64Test \
            :prism-demo:assemblePrismDemoDebugXCFramework \
            --configuration-cache-problems=warn \
            -Pkotlin.native.parallelThreads=3 || EXIT=$?
          echo "### Apple Tests + XCFramework: $((SECONDS - START))s" >> "$GITHUB_STEP_SUMMARY"
          exit ${EXIT:-0}

      - name: Verify XCFramework exports
        run: |
          XCF_ROOT="prism-demo/build/XCFrameworks/debug/PrismDemo.xcframework"
          echo "### XCFramework Verification" >> "$GITHUB_STEP_SUMMARY"
          echo "| Slice | Header | Exported Types |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-------|--------|----------------|" >> "$GITHUB_STEP_SUMMARY"

          FAIL=0
          for SLICE in ios-arm64 ios-arm64-simulator; do
            HEADER="${XCF_ROOT}/${SLICE}/PrismDemo.framework/Headers/PrismDemo.h"
            if [ -f "$HEADER" ]; then
              TYPES=$(grep -c '@interface PrismDemo' "$HEADER" || true)
              echo "| ${SLICE} | Found | ${TYPES} |" >> "$GITHUB_STEP_SUMMARY"
            else
              echo "| ${SLICE} | **MISSING** | - |" >> "$GITHUB_STEP_SUMMARY"
              echo "::error::XCFramework header not found: ${HEADER}"
              FAIL=1
            fi
          done
          exit $FAIL

      - name: Upload XCFramework
        uses: actions/upload-artifact@v4
        with:
          name: PrismDemo-debug.xcframework
          path: prism-demo/build/XCFrameworks/debug/PrismDemo.xcframework
          retention-days: 14

      - name: Generate Xcode project
        run: |
          brew install xcodegen
          cd prism-ios-demo && xcodegen generate

      - name: Build iOS app
        run: |
          set -o pipefail
          START=$SECONDS
          xcodebuild -project prism-ios-demo/PrismiOSDemo.xcodeproj \
            -scheme PrismiOSDemo -sdk iphonesimulator -arch arm64 \
            -configuration Debug CODE_SIGNING_ALLOWED=NO build 2>&1 | tail -30 || EXIT=$?
          echo "### xcodebuild: $((SECONDS - START))s" >> "$GITHUB_STEP_SUMMARY"
          exit ${EXIT:-0}
