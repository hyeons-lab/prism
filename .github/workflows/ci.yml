name: CI

on:
  push:
    branches: [main]
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  ci:
    name: Build & Check
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 25 (for toolchain)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "25"

      - name: Set up JDK 21 (default)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}
          add-job-summary: always

      - name: Setup wgpu4k
        uses: ./.github/actions/setup-wgpu4k

      - name: Lint, analyze & test
        run: |
          START=$SECONDS
          ./gradlew ktfmtCheck detektJvmMain jvmTest \
            --configuration-cache || EXIT=$?
          echo "### Lint + Test: $((SECONDS - START))s" >> "$GITHUB_STEP_SUMMARY"
          exit ${EXIT:-0}

      - name: Gradle build cache diagnostics
        if: always()
        run: |
          echo "### Gradle Build Cache" >> "$GITHUB_STEP_SUMMARY"
          CACHE_DIR=~/.gradle/caches/build-cache-1
          if [ -d "$CACHE_DIR" ]; then
            ENTRY_COUNT=$(find "$CACHE_DIR" -type f | wc -l)
            CACHE_SIZE=$(du -sh "$CACHE_DIR" | cut -f1)
            echo "| Metric | Value |" >> "$GITHUB_STEP_SUMMARY"
            echo "|--------|-------|" >> "$GITHUB_STEP_SUMMARY"
            echo "| Entries | ${ENTRY_COUNT} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| Size | ${CACHE_SIZE} |" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "No local build cache directory found." >> "$GITHUB_STEP_SUMMARY"
          fi

  apple:
    name: Apple Targets
    runs-on: macos-15
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 25 (for toolchain)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "25"

      - name: Set up JDK 21 (default)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}
          add-job-summary: always

      - name: Get Kotlin version
        id: kotlin-version
        run: |
          KOTLIN=$(grep '^kotlin ' gradle/libs.versions.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          if [ -z "$KOTLIN" ]; then
            echo "::error::Failed to extract Kotlin version from libs.versions.toml"
            exit 1
          fi
          echo "version=$KOTLIN" >> "$GITHUB_OUTPUT"

      - name: Cache Kotlin/Native toolchain
        uses: actions/cache@v4
        with:
          path: ~/.konan
          key: ${{ runner.os }}-konan-${{ steps.kotlin-version.outputs.version }}

      - name: Setup wgpu4k
        uses: ./.github/actions/setup-wgpu4k
        with:
          rust-targets: aarch64-apple-ios,aarch64-apple-ios-sim

      - name: Apple native tests + XCFrameworks
        run: |
          START=$SECONDS
          ./gradlew macosArm64Test iosSimulatorArm64Test \
            :prism-demo:assemblePrismDemoDebugXCFramework \
            :prism-ios:assemblePrismDebugXCFramework \
            --configuration-cache \
            -Pkotlin.native.parallelThreads=3 || EXIT=$?
          echo "### Apple Tests + XCFrameworks: $((SECONDS - START))s" >> "$GITHUB_STEP_SUMMARY"
          exit ${EXIT:-0}

      - name: Verify XCFramework headers
        run: |
          echo "### XCFramework Verification" >> "$GITHUB_STEP_SUMMARY"
          echo "| Framework | Slice | Header |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-----------|-------|--------|" >> "$GITHUB_STEP_SUMMARY"

          FAIL=0
          for FW in "prism-ios/build/XCFrameworks/debug/Prism.xcframework:Prism"; do
            XCF_ROOT="${FW%%:*}"
            FW_NAME="${FW##*:}"
            for SLICE in ios-arm64 ios-arm64-simulator; do
              HEADER="${XCF_ROOT}/${SLICE}/${FW_NAME}.framework/Headers/${FW_NAME}.h"
              if [ -f "$HEADER" ]; then
                echo "| ${FW_NAME} | ${SLICE} | Found |" >> "$GITHUB_STEP_SUMMARY"
              else
                echo "| ${FW_NAME} | ${SLICE} | **MISSING** |" >> "$GITHUB_STEP_SUMMARY"
                echo "::error::XCFramework header not found: ${HEADER}"
                FAIL=1
              fi
            done
          done
          exit $FAIL

      - name: Upload Prism XCFramework
        uses: actions/upload-artifact@v4
        with:
          name: Prism-debug.xcframework
          path: prism-ios/build/XCFrameworks/debug/Prism.xcframework
          retention-days: 14

      - name: Get xcodegen version
        id: xcodegen-version
        run: |
          VERSION=$(brew info --json=v2 xcodegen | jq -r '.formulae[0].versions.stable')
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Cache xcodegen
        id: cache-xcodegen
        uses: actions/cache@v4
        with:
          path: /opt/homebrew/Cellar/xcodegen
          key: xcodegen-${{ runner.os }}-${{ steps.xcodegen-version.outputs.version }}

      - name: Install xcodegen
        if: steps.cache-xcodegen.outputs.cache-hit != 'true'
        run: brew install xcodegen

      - name: Link xcodegen
        if: steps.cache-xcodegen.outputs.cache-hit == 'true'
        run: brew link --overwrite xcodegen 2>/dev/null || true

      - name: Generate Xcode project
        run: cd prism-ios-demo && xcodegen generate

      - name: Build iOS app
        run: |
          set -o pipefail
          START=$SECONDS
          xcodebuild -project prism-ios-demo/PrismiOSDemo.xcodeproj \
            -scheme PrismiOSDemo -sdk iphonesimulator -arch arm64 \
            -configuration Debug CODE_SIGNING_ALLOWED=NO build 2>&1 | tail -30 || EXIT=$?
          echo "### xcodebuild: $((SECONDS - START))s" >> "$GITHUB_STEP_SUMMARY"
          exit ${EXIT:-0}
