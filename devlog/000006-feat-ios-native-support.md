# 000006-feat-ios-native-support

## Session 1 — iOS Native Support M7 (2026-02-15 13:22 PST, claude-opus-4-6)

**Agent:** Claude Code (claude-opus-4-6) @ `prism` branch `feat/ios-native-support`

### Intent
Implement iOS native support (M7) so the existing DemoScene (rotating lit cube) runs natively on iOS via an Xcode project generated by xcodegen. This involves moving DemoScene.kt to commonMain, creating an iOS entry point using MTKViewDelegateProtocol + wgpu4k's iosContextRenderer, building an XCFramework, and scaffolding an Xcode project.

### What Changed
- **[2026-02-15 13:22 PST]** Created implementation plan → [devlog/plans/000006-01-ios-native-support.md](plans/000006-01-ios-native-support.md)
- **[2026-02-15 13:25 PST]** `prism-demo/build.gradle.kts` — Moved wgpu4k + wgpu4k-toolkit deps from jvmMain/wasmJsMain to commonMain; added XCFramework binary config with `XCFramework("PrismDemo")` for iosArm64/iosSimulatorArm64 static frameworks; added import for `org.jetbrains.kotlin.gradle.plugin.mpp.apple.XCFramework`
- **[2026-02-15 13:25 PST]** `prism-demo/src/commonMain/.../DemoScene.kt` — Moved from jvmMain to commonMain (git mv, no code changes). Enables iOS, WASM, and any future platform to share the scene factory.
- **[2026-02-15 13:27 PST]** `prism-demo/src/wasmJsMain/.../Main.kt` — Refactored to use shared `createDemoScene()` from commonMain. Removed ~40 lines of duplicated scene setup (Engine, World, Camera, Cube entity creation). Kept WASM-specific render loop (requestAnimationFrame) and error handling.
- **[2026-02-15 13:35 PST]** `prism-demo/src/iosMain/.../IosDemoController.kt` — New. Entry point for iOS: `suspend fun configureDemo(view: MTKView)` creates wgpu context via `iosContextRenderer()`, builds shared DemoScene, installs `DemoRenderDelegate` as MTKView delegate. `DemoRenderDelegate` implements `MTKViewDelegateProtocol` with `drawInMTKView()` for frame rendering and `mtkView(drawableSizeWillChange:)` for resize handling. Uses `CACurrentMediaTime()` for frame timing.
- **[2026-02-15 13:38 PST]** `prism-renderer/src/iosMain/.../RenderSurface.ios.kt` — Replaced `TODO()` crash in `configure()` with Kermit logging. On iOS the GPU surface is managed by MTKView/wgpu4k externally, so RenderSurface only stores dimensions.
- **[2026-02-15 13:40 PST]** `ios-demo/project.yml` — New. xcodegen spec for PrismDemo iOS app targeting iOS 15.0. Links PrismDemo.xcframework + MetalKit + Metal frameworks.
- **[2026-02-15 13:40 PST]** `ios-demo/Sources/{AppDelegate,ViewController}.swift` — New. Swift entry point: AppDelegate creates UIWindow, ViewController creates MTKView with Metal device and calls `IosDemoControllerKt.configureDemo(view:)` via Kotlin framework interop.
- **[2026-02-15 13:40 PST]** `ios-demo/Sources/Info.plist` — New. Standard iOS plist requiring Metal capability.
- **[2026-02-15 13:41 PST]** `.gitignore` — Added entries for generated Xcode project files (*.xcodeproj, *.xcworkspace, DerivedData).
- **[2026-02-15 13:45 PST]** `BUILD_STATUS.md` — Updated M7 from ⏳ to ✅ with details on all changes. Added iOS build commands.

### Decisions
- **[2026-02-15 13:22 PST]** **Move wgpu4k deps to commonMain in prism-demo** — Since prism-renderer already has wgpu4k in commonMain, and DemoScene uses WGPUContext (a wgpu4k type), moving the deps to commonMain is the cleanest approach to share DemoScene across all platforms.
- **[2026-02-15 13:35 PST]** **Use `@OptIn(BetaInteropApi::class)` for DemoRenderDelegate** — K/N requires this for classes implementing ObjC protocols via `NSObject()`. This is the standard pattern for MTKViewDelegateProtocol.
- **[2026-02-15 13:38 PST]** **RenderSurface.ios.kt: log instead of TODO** — The RenderSurface abstraction isn't used on the iOS wgpu4k path (surface is created by `iosContextRenderer` from MTKView directly), so the stub just needs to not crash.
- **[2026-02-15 13:40 PST]** **Static XCFramework** — Used `isStatic = true` for the framework to avoid needing to embed a dynamic framework in the iOS app bundle.

### Research & Discoveries
- wgpu4k-toolkit publishes `iosArm64`, `iosSimulatorArm64`, and `iosX64` variants in its Gradle module metadata
- `iosContextRenderer(view: MTKView, width: Int, height: Int)` is a suspend function that extracts the CAMetalLayer from the MTKView's layer via `objcPtr()` pointer casting, then creates WGPU instance → surface → adapter → device
- `IosContext` wraps `WGPUContext` and the `MTKView` reference, implements `AutoCloseable`
- `XCFramework` class requires explicit import: `import org.jetbrains.kotlin.gradle.plugin.mpp.apple.XCFramework`
- K/N `MTKViewDelegateProtocol.mtkView(view:, drawableSizeWillChange:)` receives `CValue<CGSize>` — use `.useContents {}` to unpack
- `CACurrentMediaTime()` from `platform.QuartzCore` gives high-resolution monotonic time (seconds as Double)

### Issues
- **XCFramework import** — Initial build failed with "Unresolved reference 'XCFramework'" because the class needs an explicit import in build.gradle.kts. Fixed by adding `import org.jetbrains.kotlin.gradle.plugin.mpp.apple.XCFramework` at top of file.

### Lessons Learned
- wgpu4k's iOS path is clean: `iosContextRenderer` handles all the Metal/WGPU plumbing. The Kotlin side just needs to create an MTKView in Swift, pass it to Kotlin, and implement `MTKViewDelegateProtocol` for the render loop.
- `applyDefaultHierarchyTemplate()` automatically creates `iosMain` intermediate source set when both `iosArm64()` and `iosSimulatorArm64()` targets are declared — no manual `dependsOn` wiring needed.

### Commits
- `1bd8607` — chore: add devlog for iOS native support (M7)
- `3b61b04` — refactor: move DemoScene to commonMain and consolidate wgpu4k deps
- `de51ecc` — feat: add iOS native rendering with MTKView delegate
- `890cc9f` — feat: add Xcode project for iOS demo via xcodegen

---

## Session 2 — Critical Review Fixes (2026-02-15 14:30 PST, claude-opus-4-6)

**Agent:** Claude Code (claude-opus-4-6) @ `prism` branch `feat/ios-native-support`

### Intent
Address critical review findings from self-review of PR #15. The review found 3 P0 critical issues (resource leaks, no error handling), 3 P1 issues (zero drawable size, wrong device capability, deprecated lifecycle), and 5 P2 quality issues. Created review plan at [devlog/plans/000006-02-ios-review-fixes.md](plans/000006-02-ios-review-fixes.md).

### What Changed
- **[2026-02-15 14:30 PST]** `prism-demo/src/iosMain/.../IosDemoController.kt` — Added `IosDemoHandle` class wrapping `IosContext` + `DemoScene` with `shutdown()` method. `configureDemo()` now returns `IosDemoHandle` instead of bare `IosContext`. Added fallback to 800x600 defaults if `drawableSize` is zero (not yet computed in `viewDidLoad`). Changed `ROTATION_SPEED` from `const val` to `val` (`.toFloat()` is not a compile-time constant).
- **[2026-02-15 14:30 PST]** `ios-demo/Sources/ViewController.swift` — Store `IosDemoHandle` as property, call `shutdown()` in `deinit`. Added `showError()` method that displays a UILabel with red background when Metal or wgpu init fails. Guard Metal device creation with `showError` instead of `fatalError`.
- **[2026-02-15 14:30 PST]** `ios-demo/Sources/Info.plist` — Fixed `armv7` → `arm64` in `UIRequiredDeviceCapabilities` (XCFramework only has arm64 slices). Added `UISupportedInterfaceOrientations~ipad` with all 4 orientations including portrait-upside-down.

### Decisions
- **[2026-02-15 14:30 PST]** **`IosDemoHandle` as lifecycle manager** — Rather than exposing `IosContext` and `DemoScene` separately to Swift, wrap both in a single handle with one `shutdown()` method. Mirrors the pattern from JVM (`scene.shutdown()` in `windowClosing`) and WASM (`scene.shutdown()` in `onBeforeUnload`).
- **[2026-02-15 14:30 PST]** **Defer P1 #7 (UISceneDelegate modernization) to issue #16** — Using the scene delegate pattern requires restructuring both Swift files significantly. The current UIApplicationDelegate pattern works on iOS 15+ with a deprecation warning. Better to fix in a focused follow-up.
- **[2026-02-15 14:30 PST]** **Defer P2 #8 (Compose deps in iOS binary) to issue #17** — Pre-existing issue, not introduced by this PR. Needs a source set restructuring across prism-demo.
- **[2026-02-15 14:30 PST]** **Defer P2 #11 (rotation logic duplication) to issue #18** — Demo code duplication, not a correctness issue. Could extract `DemoScene.tick()` but that's a separate refactor.

### Issues
- **P0 #1 & #2: IosContext and DemoScene leaked** — `configureDemo()` returned `IosContext` but Swift discarded it. `DemoScene` was captured by `DemoRenderDelegate` but had no shutdown path. Fixed by adding `IosDemoHandle` with `shutdown()`, stored in ViewController, called from `deinit`.
- **P0 #3: No error handling in Swift** — If Metal or wgpu init failed, the app either crashed (`fatalError`) or silently showed a black screen. Fixed by adding `showError()` that displays a user-visible UILabel.
- **P1 #4: drawableSize zero at init** — `MTKView.drawableSize` may not be computed in `viewDidLoad`. Fixed by checking for zero and falling back to 800x600 defaults. `mtkView(drawableSizeWillChange:)` corrects the aspect ratio on first layout.
- **P1 #6: armv7 in UIRequiredDeviceCapabilities** — XCFramework only contains arm64 slices; `armv7` was incorrect. Fixed to `arm64`.
- **P1 #7: Deprecated UIWindow lifecycle** — Deferred to issue #16.
- **P2 #8: Compose deps in iOS binary** — Deferred to issue #17.
- **P2 #11: Rotation logic duplication** — Deferred to issue #18.

### Commits
- `ae9ce40` — fix: address critical review findings for iOS native support

---

## Next Steps
- Run `xcodegen generate` in ios-demo/ and verify Xcode build on simulator
- #16: Modernize to UISceneDelegate lifecycle
- #17: Move Compose deps out of commonMain
- #18: Extract shared rotation logic to DemoScene.tick()
- Mobile platform work: Android support (M8)
