# 000017 — feat/ffi-kmp-bindings

**Agent:** Claude Code (claude-sonnet-4-6) @ hyeons-lab/prism branch feat/ffi-kmp-bindings
**Intent:** Implement auto-generated JS and native bindings for Prism (issue #40) — `prism-js` module (WASM/TypeScript SDK) and `prism-native` module (Kotlin/Native C API), with ffigen-based Dart FFI bindings and auto-generated Dart `@JS()` bindings.

## Progress

- [x] Step 1 — Annotate clean types with `@JsExport` (effectively a no-op — see Decisions)
- [x] Step 2 — Create `prism-js` module (WASM/TypeScript SDK)
- [x] Step 3 — Create `prism-native` module (Kotlin/Native C API)
- [x] Step 4 — Wire Dart FFI bindings via ffigen
- [x] Step 5 — Auto-generate Dart `@JS()` bindings from `.d.mts`
- [x] Step 6 — Update `prism-flutter` to use generated bindings
- [x] Step 7 — macOS Flutter Desktop Support (FFI via SPM) — issue #828

## What Changed

`settings.gradle.kts` — Added `include(":prism-js")` and `include(":prism-native")` to the include list.

`prism-js/build.gradle.kts` — New module: wasmJs target with `generateTypeScriptDefinitions()`, depends on prism-math, prism-core, prism-scene, prism-ecs.

`prism-js/src/wasmJsMain/kotlin/engine/prism/js/Registry.kt` — String-keyed opaque handle registry; Kotlin objects stay Kotlin-side and are referenced by String IDs across the WASM JS boundary.

`prism-js/src/wasmJsMain/kotlin/engine/prism/js/EngineApi.kt` — `@JsExport` bridge functions for engine lifecycle: `prismCreateEngine`, `prismEngineInitialize`, `prismEngineIsAlive`, `prismEngineGetDeltaTime`, `prismEngineGetTotalTime`, `prismDestroyEngine`.

`prism-js/src/wasmJsMain/kotlin/engine/prism/js/SceneApi.kt` — `@JsExport` bridge functions for scene/node management: create/destroy scene, create/add/destroy nodes, set position/rotation/scale, set active camera.

`prism-js/src/wasmJsMain/kotlin/engine/prism/js/EcsApi.kt` — `@JsExport` bridge functions for ECS world: create world, create/destroy entities, add transform component, get transform X/Y/Z.

`prism-js/src/wasmJsMain/kotlin/engine/prism/js/MeshApi.kt` — `@JsExport` builder-pattern mesh API: create builder, add vertex floats and indices one-at-a-time, finalize into mesh ID. (Arrays cannot cross the WASM JS boundary — see Issues.)

`prism-native/build.gradle.kts` — New module: iosArm64, iosSimulatorArm64, macosArm64, linuxX64, mingwX64 targets; each with `sharedLib { baseName = "prism" }`. Depends on prism-math and prism-core only (prism-scene/prism-ecs lack desktop targets). Includes `generateFfiBindings` task that calls `dart run ffigen`.

`prism-native/src/nativeMain/kotlin/engine/prism/native/Registry.kt` — Long-keyed opaque handle registry for the C API.

`prism-native/src/nativeMain/kotlin/engine/prism/native/NativeBridge.kt` — `@CName`-annotated functions exporting 7 C symbols: `prism_create_engine`, `prism_engine_initialize`, `prism_engine_is_alive`, `prism_engine_get_delta_time`, `prism_engine_get_total_time`, `prism_engine_get_frame_count`, `prism_destroy_engine`.

`prism-flutter/build.gradle.kts` — Added `generateDartJsBindings` task: reads `prism.d.mts` from prism-js build output and emits `prism_js_bindings.dart` with `@JS()` declarations and `prismJsExportNames` list.

`prism-flutter/flutter_plugin/pubspec.yaml` — Added `ffi: ^2.1.0` dep, `ffigen: ^13.0.0` dev dep; added `ffiPlugin: true` and macOS/Linux/Windows platform entries under `flutter.plugin.platforms`.

`prism-flutter/flutter_plugin/ffigen.yaml` — ffigen config: reads `libprism_api.h` from prism-native macosArm64 debug build, includes only `prism_.*` functions, outputs to `lib/src/generated/prism_native_bindings.dart`.

`prism-flutter/flutter_plugin/lib/src/generated/prism_native_bindings.dart` — AUTO-GENERATED by ffigen: `PrismNativeBindings` class with 7 `dart:ffi` bound methods.

`prism-flutter/flutter_plugin/lib/src/generated/prism_js_bindings.dart` — AUTO-GENERATED by `generateDartJsBindings` task: `prismJsExportNames` const list + 35 `@JS()` external function declarations covering all prism-js exports.

`prism-flutter/flutter_plugin/lib/src/prism_engine_ffi.dart` — New `PrismEngine` FFI implementation using `PrismNativeBindings`; loads `libprism.dylib`/`.so`/`.dll` depending on platform. Provides `initialize`, `togglePause` (stub), `isInitialized`, `getState`, `shutdown`.

`prism-flutter/flutter_plugin/lib/src/prism_web_plugin.dart` — Removed 5 hand-written `@JS()` declarations; imports `generated/prism_js_bindings.dart`. Window-pinning script now iterates `prismJsExportNames` (35 functions). `PrismWebEngine` updated to use handle-based API (`prismCreateEngine` + `prismEngineInitialize` in `init()`; `prismEngineIsAlive`/`prismEngineGetDeltaTime`/`prismEngineGetTotalTime`/`prismDestroyEngine` in instance methods).

`prism-flutter/flutter_plugin/lib/src/prism_engine.dart` — Added TODO comment about wiring `prism_engine_ffi.dart` once native library bundling per-platform is solved.

`prism-flutter/flutter_plugin/lib/src/prism_web_plugin.dart` (post-fix) — Reverted `PrismWebEngine` to use high-level Flutter WASM API (`prismInit`, `prismTogglePause`, etc.). Window-pinning script now pins both the Flutter API names and all `prismJsExportNames` so the low-level handle API is also accessible to external JS.

`prism-flutter/build.gradle.kts` (post-fix) — Added `:kotlinWasmNpmInstall` (root-project task, fixed path from bare `kotlinWasmNpmInstall`) as dependency of `copyWasmToFlutterWeb` so `skiko.mjs`/`skiko.wasm` are always extracted from Gradle cache. Added copy of `prism.mjs`, `prism.uninstantiated.mjs`, `prism.wasm` from `:prism-js` build output and `prism-sdk.mjs` from `:prism-js` project directory into `flutter_plugin/example/web/`.

`prism-js/prism-sdk.mjs` — New hand-written ES module OO façade over the flat `@JsExport` API. Exports: `PrismEngine`, `PrismWorld`, `PrismScene`, `PrismMeshNode`, `PrismCameraNode`, `PrismLightNode`, `PrismEmptyNode`, `PrismMeshBuilder`.

`prism-flutter/flutter_plugin/lib/src/prism_sdk_types.dart` — New shared value types (`Vec3`, `EngineConfig`, `TransformComponent`, `Entity`) used by both web and stub Dart SDK implementations.

`prism-flutter/flutter_plugin/lib/src/prism_sdk_web.dart` — New web Dart SDK wrapper routing all calls to prism.mjs via generated `@JS()` bindings. Mirrors Kotlin API: `Engine`, `World`, `Scene`, `Node`, `MeshNode`, `CameraNode`, `LightNode`.

`prism-flutter/flutter_plugin/lib/src/prism_sdk_stub.dart` — Stub implementation that throws `UnsupportedError` on all non-web platforms; allows web-only Dart code to compile everywhere.

`prism-flutter/flutter_plugin/lib/prism_sdk.dart` — Conditional export: routes to web impl when `dart.library.js_interop` is available, stub otherwise.

`docs/index.html` (second review) — Added Kotlin and Swift import statements to snippets; fixed Swift imports from four separate module imports to single `import Prism` (baseName = "Prism" in prism-ios).

`prism-js/prism-sdk.mjs` (second review fixes) — Renamed all `PrismX` → `X` to match Kotlin API. Added `Vec3`, `EngineConfig`, `TransformComponent`. `Vec3.zero`/`Vec3.one` changed from getters (new object each access) to frozen static fields. `World.addComponent` now throws `TypeError` for unsupported component types. `Scene.activeCamera` setter now validates `instanceof CameraNode` before delegating.

`prism-flutter/flutter_plugin/lib/src/prism_sdk_web.dart` (second review fixes) — Removed duplicate `export 'prism_sdk_types.dart'` (was causing compile error — `prism_sdk.dart` already exports it). Removed unused `dart:js_interop` import. `World.addComponent` now throws `ArgumentError` for unsupported component types. Added doc comment on `Node._handle` clarifying the library-private subclassing limitation.

`prism-flutter/flutter_plugin/lib/src/prism_sdk_stub.dart` (second review fixes) — Changed `export 'prism_sdk_types.dart'` to `import` (was a duplicate export via `prism_sdk.dart`).

`prism-flutter/flutter_plugin/lib/src/prism_engine_ffi.dart` (second review fixes) — `nativeName.cast()` → `nativeName.cast<Void>()` (explicit type, matches generated binding for `void* appName`). Moved `prism_engine_initialize` and `_initialized = true` inside the `try` block; added `catch` that destroys the engine handle before rethrowing so no handle leaks if initialize fails.

`prism-flutter/flutter_plugin/example/web/.gitignore` — Gitignore for generated WASM/JS artifacts (`prism-flutter.{mjs,wasm}`, `prism.{mjs,wasm}`, `prism-sdk.mjs`, `skiko.{mjs,wasm}`).

`docs/index.html` — API section unhidden; JS snippet updated to use class-based `prism-sdk.mjs` API; all 5 code snippets made consistent (create engine → setup content → query state) and non-collapsible; architecture diagram extended with prism-js / prism-native; M12 milestone added.

`docs/style.css` — `.lang-label` always shows `border-bottom`; removed `cursor: pointer` and `details[open]` rule.

`prism-flutter/build.gradle.kts` — Added `bundleNativeMacOS` task: depends on `:prism-native:linkReleaseSharedMacosArm64`, runs `xcodebuild -create-xcframework` to wrap `libprism.dylib` into `flutter_plugin/macos/Frameworks/PrismNative.xcframework`. SPM binary targets require XCFrameworks; raw dylibs are not supported.

`prism-flutter/flutter_plugin/macos/Package.swift` — New: SPM manifest declaring `prism_flutter` Swift target (sources in `Classes/`) and `PrismNative` binary target pointing at `Frameworks/PrismNative.xcframework`. Requires macOS 13+.

`prism-flutter/flutter_plugin/macos/Classes/PrismFlutterPlugin.swift` — New: minimal `FlutterPlugin` registration stub. Imports `PrismNative` so the linker embeds the XCFramework in the app bundle. No MethodChannel — all engine calls go through Dart FFI.

`prism-flutter/flutter_plugin/macos/Frameworks/.gitignore` — New: ignores the built `PrismNative.xcframework` (generated artifact, same pattern as other build outputs).

`prism-flutter/flutter_plugin/lib/src/prism_engine_dispatch.dart` — New: runtime dispatcher using `dart:io Platform` checks; routes to `ffi.PrismEngine` on macOS/Linux/Windows and `channel.PrismEngine` on iOS/Android. Resolves the `dart.library.ffi` ambiguity (true on all native platforms).

`prism-flutter/flutter_plugin/lib/src/prism_engine.dart` — Updated export: removed stale TODO; now exports `prism_engine_dispatch.dart` for native and `prism_engine_web.dart` for web via `dart.library.js_interop` conditional.

`prism-flutter/flutter_plugin/lib/src/prism_render_view_mobile.dart` — Added macOS case returning a placeholder `Text` widget. Full render surface is future work; engine API via `PrismEngine` is usable now.

`prism-flutter/flutter_plugin/pubspec.yaml` — Added `macos: pluginClass: PrismFlutterPlugin` under `flutter.plugin.platforms`.

`prism-flutter/flutter_plugin/macos/prism_flutter/Package.swift` — Replaced `macos/Package.swift`: moved to Flutter's required path `macos/prism_flutter/Package.swift`; product name changed to `prism-flutter` (hyphen, Flutter replaces `_` with `-`); platform lowered to `.macOS(.v10_15)` to match `FlutterGeneratedPluginSwiftPackage`; XCFramework path changed to `Frameworks/PrismNative.xcframework` (self-contained within the package dir).

`prism-flutter/flutter_plugin/macos/prism_flutter/Sources/prism_flutter/PrismFlutterPlugin.swift` — Moved from `macos/Classes/`; removed `import PrismNative` (the dylib has no Swift module interface; SPM dependency is enough for embedding).

`prism-flutter/flutter_plugin/lib/src/prism_engine_ffi.dart` — Changed macOS from `DynamicLibrary.open('libprism.dylib')` to `DynamicLibrary.process()`: SPM embeds and auto-loads `libprism.dylib` via dyld before Dart runs; calling `open()` loaded a second copy causing duplicate ObjC class warnings and crashes.

`prism-flutter/flutter_plugin/ios/prism_flutter/Package.swift` — New: SPM manifest for iOS, mirroring macOS pattern. `PrismDemo` binary target at `Frameworks/PrismDemo.xcframework`; `prism_flutter` target at `Sources/prism_flutter`; product name `prism-flutter`.

`prism-flutter/flutter_plugin/ios/prism_flutter/Frameworks/.gitignore` — New: ignores built `PrismDemo.xcframework`.

`prism-flutter/flutter_plugin/ios/prism_flutter.podspec` — Deleted: replaced by SPM.

`prism-flutter/flutter_plugin/ios/{Classes → prism_flutter/Sources/prism_flutter}/` — Moved both Swift sources to Flutter's SPM-expected path.

`prism-flutter/build.gradle.kts` — Added `bundleNativeiOS` task: depends on `:prism-demo-core:assemblePrismDemoReleaseXCFramework`, copies output to `flutter_plugin/ios/prism_flutter/Frameworks/PrismDemo.xcframework`.

`prism-flutter/flutter_plugin/lib/src/prism_engine_channel.dart` — Added no-op `initialize()` method so `prism_engine_dispatch.dart` can call it uniformly on all platforms without `NoSuchMethodError` on mobile.

`prism-flutter/flutter_plugin/example/lib/main.dart` — Added `_engine.initialize()` call in `initState()`. On mobile it is a no-op (engine starts via platform view); on macOS it starts the native FFI engine.

`prism-flutter/flutter_plugin/example/macos/` — Scaffolded via `flutter create --platforms macos .`: standard Xcode runner project, entitlements, AppInfo.xcconfig, and gitignore for ephemeral/Pods.

## Decisions

**2026-02-20 Step 1 is a no-op** — Kotlin 2.3.0 WasmJS: `@JsExport` is function-only; applying it to a class/data class yields "This annotation is not applicable to target 'class'. Applicable targets: function". The plan's Step 1 (annotate source types) was incompatible with the current compiler. Decision: use primitives-only at the boundary via the opaque-handle registry pattern, which is architecturally cleaner anyway.

**2026-02-20 prism-native depends only on prism-math + prism-core** — `prism-scene` and `prism-ecs` don't declare linuxX64/mingwX64 targets. Adding those dependencies would cause resolution failures on desktop targets. Scene/ECS operations in the C API are deferred to a follow-up.

**2026-02-20 MeshApi uses builder pattern** — `FloatArray`/`IntArray` cannot cross the WASM JS boundary ("Only external, primitive, string, and function types are supported"). Replaced `prismMeshFromArrays(vertices: FloatArray, indices: IntArray)` with an explicit builder: `prismMeshBuilderCreate` → `prismMeshBuilderAddVertexFloat`/`prismMeshBuilderAddIndex` → `prismMeshBuilderFinalize`.

**2026-02-20 generateDartJsBindings reads `.d.mts`** — The Kotlin WasmJS compiler emits `prism.d.mts` (ESM TypeScript), not `prism.d.ts`. The Gradle task was written to read `prism.d.mts`. ffigen yaml also updated to reference the correct path.

**2026-02-20 FFI conditional export deferred** — `dart.library.ffi` is `true` on all native targets including Android/iOS. We can't currently use it to select the FFI impl only on desktop. Left a TODO comment; `prism_engine_channel.dart` remains the default for all non-web native platforms.

**2026-02-20 prism_web_plugin.dart reverted to old flutter API** — Initial Step 6 update called `prismCreateEngine` (new prism-js API), but `prism-flutter.mjs` only exports the old `prismInit`/`prismTogglePause` etc. from `FlutterWasmEntry.kt`. These are two separate WASM modules. `PrismWebEngine` was reverted to the old high-level API; `prismJsExportNames` is only used for window-pinning the low-level API alongside the flutter names.

**2026-02-20 prism-sdk.mjs: OO JS façade** — The flat `@JsExport` API surface is verbose for JS consumers. Created `prism-sdk.mjs` as a hand-written ES module that wraps the handle-based API with classes (`PrismEngine`, `PrismWorld`, `PrismScene`, `PrismMeshNode`, etc.) mirroring the Kotlin class hierarchy. This is a companion file shipped with `prism.mjs` for JS users.

**2026-02-20 MeshBuilder finalize redesign** — `prismMeshBuilderFinalize` originally discarded the vertex/index data. Since arrays can't cross the WASM boundary there is no single-call mechanism to retrieve the mesh data; finalize now freezes the builder and keeps the handle alive. Callers read data back element-at-a-time via `prismMeshBuilderGetVertexAt`/`prismMeshBuilderGetIndexAt`, then call `prismMeshBuilderDestroy`.

**2026-02-20 Window-pinning switched to dynamic enumeration** — `prism_web_plugin.dart` was importing the generated `prism_js_bindings.dart` solely to get a hardcoded name list for window-pinning. Replaced with `for (const [name, value] of Object.entries(mod))` in the inline JS script, which automatically pins every exported function with no list to maintain and no generated-file dependency.

**2026-02-20 Generated files removed from git** — `prism_js_bindings.dart` and `prism_native_bindings.dart` were committed, creating a drift risk. Replaced with `generated/.gitignore` (covers `*.dart`). Regeneration steps: `./gradlew :prism-flutter:generateDartJsBindings` (JS) and `./gradlew :prism-native:generateFfiBindings` (native).

**2026-02-20 Dart SDK wrapper: conditional export pattern** — `prism_sdk.dart` uses `export … if (dart.library.js_interop) …` so web code gets the real implementation and non-web gets stubs that throw `UnsupportedError`. Both files must only `import` (not `export`) shared types since `prism_sdk.dart` already re-exports `prism_sdk_types.dart`.

**2026-02-20 Swift import is `import Prism`** — Confirmed from `prism-ios/build.gradle.kts`: `baseName = "Prism"`. The KMP iOS XCFramework exposes a single umbrella module, not separate `PrismCore`/`PrismEcs`/etc. modules. Previous docs snippet was wrong.

**2026-02-20 Vec3 statics: frozen fields not getters** — `static get zero()` returns a new object on every access, causing unexpected inequality and wasted allocations in default parameter expressions. Changed to `static zero = Object.freeze(new Vec3(0,0,0))` — allocated once at class definition time.

**2026-02-20 `addComponent` should throw on unknown types** — Silent no-op for unsupported component types masks caller bugs. Both the JS façade and the Dart web impl now throw `TypeError`/`ArgumentError` for unrecognised types. The stub already throws `UnsupportedError` for all calls so no change needed there.

**2026-02-20 `prism_create_engine` takes `void*`** — Confirmed from generated `libprism_api.h`: `prism_create_engine(void* appName, …)`. The Dart `cast()` call must be `cast<Void>()` to match; leaving it implicit would fail if the analyzer cannot infer the type from context.

**2026-02-21 macOS uses SPM binary target, not CocoaPods** — SPM binary targets require XCFrameworks; raw `.dylib` files are not accepted. `bundleNativeMacOS` wraps `libprism.dylib` via `xcodebuild -create-xcframework`. This mirrors the iOS SPM pattern already used for `Package.swift` at the repo root.

**2026-02-21 Runtime dispatch instead of compile-time conditional** — `dart.library.ffi` is `true` on all native platforms (iOS, Android, macOS, Linux, Windows). Using it as a conditional export would silently route iOS/Android to the FFI path, breaking those platforms. Solution: `prism_engine_dispatch.dart` checks `Platform.isMacOS || Platform.isLinux || Platform.isWindows` at runtime.

**2026-02-21 `_impl` typed as `dynamic`** — Both `ffi.PrismEngine` and `channel.PrismEngine` share the same method signatures but no common interface. Typed as `dynamic` for now; extracting a shared `PrismEngineInterface` abstract class is deferred to a follow-up.

**2026-02-21 Flutter SPM path convention is `{platform}/{plugin_name}/Package.swift`** — Not `{platform}/Package.swift`. Flutter derives the path as `fileSystem.path.join(path, platformDir, name)`. Initial placement at `macos/Package.swift` caused `FlutterGeneratedPluginSwiftPackage` to have no dependencies. Moving to `macos/prism_flutter/Package.swift` fixed detection.

**2026-02-21 Flutter SPM product name uses hyphens** — Flutter calls `plugin.name.replaceAll('_', '-')` when generating the `FlutterGeneratedPluginSwiftPackage` target dependency. The plugin's `Package.swift` library product must be named `prism-flutter` (not `prism_flutter`) to match.

**2026-02-21 SPM binary target path must be inside the package directory** — Symlinks in Flutter's `.packages/` ephemeral directory are not followed by SPM for path resolution. `../Frameworks/PrismNative.xcframework` (relative to `macos/prism_flutter/`) resolved to `.packages/Frameworks/` (wrong) instead of `macos/Frameworks/`. Fixed by moving `Frameworks/` inside `macos/prism_flutter/` so the path `"Frameworks/PrismNative.xcframework"` is fully self-contained.

**2026-02-21 `DynamicLibrary.open('libprism.dylib')` causes duplicate load on macOS SPM** — SPM embeds `libprism.dylib` in the app bundle and dyld auto-loads it before Dart runs. Calling `DynamicLibrary.open('libprism.dylib')` in Flutter debug mode loaded the source-path dylib a second time (DYLD_LIBRARY_PATH pointed to the build dir), causing duplicate ObjC class warnings. Fix: use `DynamicLibrary.process()` on macOS — symbols are already in the process.

**2026-02-21 channel impl needs no-op `initialize()`** — `prism_engine_dispatch.dart` calls `_impl.initialize(...)` uniformly. `channel.PrismEngine` didn't have that method, causing `NoSuchMethodError` on mobile. Added a no-op — mobile engine starts natively via the platform view, not via an explicit call.

## Issues

**`@JsExport` on classes fails in Kotlin 2.3.0 WasmJS** — Compiler error: "This annotation is not applicable to target 'class'. Applicable targets: function". Attempted to annotate data classes (Entity, etc.) in commonMain. Reverted all class annotations. Resolution: bridge uses primitive-only boundary with opaque handles.

**prism-native directory didn't exist before prism-js build** — Gradle failed with "Configuring project ':prism-native' without an existing directory is not allowed" when `:prism-js` was added to settings first. Resolution: created stub `prism-native/build.gradle.kts` before running the prism-js build.

**`dartOut.get().asFile` compile error in Gradle task** — `layout.projectDirectory.file(...)` returns `RegularFile` (not `Provider<RegularFile>`), so `.get()` doesn't exist. Resolution: `val dartOutFile = layout.projectDirectory.file(...).asFile` — captures a plain `java.io.File` directly and is used in `doLast`.

## Commits

5d5c2df — chore: add devlog and plan for feat/ffi-kmp-bindings (issue #40)
6593425 — feat: auto-generated JS and native bindings (prism-js + prism-native)
638c90b — fix: restore flutter web demo and add kotlinWasmNpmInstall dependency
53a5c5e — docs: show API section with prism-js/native examples, add M12 milestone
8dcd3b7 — docs: consistent non-collapsing API snippets across all 5 targets
941318a — chore: update devlog with all commits and post-fix decisions
d359142 — feat(prism-js): add OO JS façade (prism-sdk.mjs) and wire into build
576d9ef — docs: merge dart panels and align all 4 snippets to same pattern
4d63535 — docs: rename dart panel label to 'Dart · Flutter'
a2f6c6b — docs: remove prism-sdk label from JS panel
4ffb75a — fix: address all critical review findings
e3eed72 — chore: update devlog with review fixes and decisions
037bfaf — feat: add Dart SDK wrapper (prism_sdk.dart) mirroring the Kotlin API
ac535e7 — docs: add import statements to Kotlin and Swift snippets
ac535e70d63eaa2a4b3d121f7e07b9a5ac77fa33 — fix: address second critical review findings
aa95126 — feat: macOS Flutter desktop support via SPM (#828)
4acc28e — feat: scaffold macOS example runner and fix channel initialize
8119203 — docs: update Dart snippet and platform table for macOS FFI
3ce2dcb — docs: align Dart snippet structure with other three panels
87c1a83 — fix: correct SPM package structure and library loading for macOS
HEAD — feat: migrate iOS plugin from CocoaPods to SPM
