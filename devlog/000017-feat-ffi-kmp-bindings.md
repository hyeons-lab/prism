# 000017 — feat/ffi-kmp-bindings

**Agent:** Claude Code (claude-sonnet-4-6) @ hyeons-lab/prism branch feat/ffi-kmp-bindings
**Intent:** Implement auto-generated JS and native bindings for Prism (issue #40) — `prism-js` module (WASM/TypeScript SDK) and `prism-native` module (Kotlin/Native C API), with ffigen-based Dart FFI bindings and auto-generated Dart `@JS()` bindings.

## Progress

- [x] Step 1 — Annotate clean types with `@JsExport` (effectively a no-op — see Decisions)
- [x] Step 2 — Create `prism-js` module (WASM/TypeScript SDK)
- [x] Step 3 — Create `prism-native` module (Kotlin/Native C API)
- [x] Step 4 — Wire Dart FFI bindings via ffigen
- [x] Step 5 — Auto-generate Dart `@JS()` bindings from `.d.mts`
- [x] Step 6 — Update `prism-flutter` to use generated bindings
- [x] Step 7 — macOS Flutter Desktop Support (FFI via SPM) — issue #828
- [x] Step 8 — Refactor iOS plugin to prism-native FFI; add macOS Metal platform view
- [x] Step 9 — Wire macOS AppKitView to wgpu via prism-native C API (wgpu4k fork)
- [x] Step 10 — Generalize `prism-flutter` + create `prism-flutter-demo` consumer module

## What Changed

`settings.gradle.kts` — Added `include(":prism-js")` and `include(":prism-native")` to the include list.

`prism-js/build.gradle.kts` — New module: wasmJs target with `generateTypeScriptDefinitions()`, depends on prism-math, prism-core, prism-scene, prism-ecs.

`prism-js/src/wasmJsMain/kotlin/engine/prism/js/Registry.kt` — String-keyed opaque handle registry; Kotlin objects stay Kotlin-side and are referenced by String IDs across the WASM JS boundary.

`prism-js/src/wasmJsMain/kotlin/engine/prism/js/EngineApi.kt` — `@JsExport` bridge functions for engine lifecycle: `prismCreateEngine`, `prismEngineInitialize`, `prismEngineIsAlive`, `prismEngineGetDeltaTime`, `prismEngineGetTotalTime`, `prismDestroyEngine`.

`prism-js/src/wasmJsMain/kotlin/engine/prism/js/SceneApi.kt` — `@JsExport` bridge functions for scene/node management: create/destroy scene, create/add/destroy nodes, set position/rotation/scale, set active camera.

`prism-js/src/wasmJsMain/kotlin/engine/prism/js/EcsApi.kt` — `@JsExport` bridge functions for ECS world: create world, create/destroy entities, add transform component, get transform X/Y/Z.

`prism-js/src/wasmJsMain/kotlin/engine/prism/js/MeshApi.kt` — `@JsExport` builder-pattern mesh API: create builder, add vertex floats and indices one-at-a-time, finalize into mesh ID. (Arrays cannot cross the WASM JS boundary — see Issues.)

`prism-native/build.gradle.kts` — New module: iosArm64, iosSimulatorArm64, macosArm64, linuxX64, mingwX64 targets; each with `sharedLib { baseName = "prism" }`. Depends on prism-math and prism-core only (prism-scene/prism-ecs lack desktop targets). Includes `generateFfiBindings` task that calls `dart run ffigen`.

`prism-native/src/nativeMain/kotlin/engine/prism/native/Registry.kt` — Long-keyed opaque handle registry for the C API.

`prism-native/src/nativeMain/kotlin/engine/prism/native/NativeBridge.kt` — `@CName`-annotated functions exporting 7 C symbols: `prism_create_engine`, `prism_engine_initialize`, `prism_engine_is_alive`, `prism_engine_get_delta_time`, `prism_engine_get_total_time`, `prism_engine_get_frame_count`, `prism_destroy_engine`.

`prism-flutter/build.gradle.kts` — Added `generateDartJsBindings` task: reads `prism.d.mts` from prism-js build output and emits `prism_js_bindings.dart` with `@JS()` declarations and `prismJsExportNames` list.

`prism-flutter/flutter_plugin/pubspec.yaml` — Added `ffi: ^2.1.0` dep, `ffigen: ^13.0.0` dev dep; added `ffiPlugin: true` and macOS/Linux/Windows platform entries under `flutter.plugin.platforms`.

`prism-flutter/flutter_plugin/ffigen.yaml` — ffigen config: reads `libprism_api.h` from prism-native macosArm64 debug build, includes only `prism_.*` functions, outputs to `lib/src/generated/prism_native_bindings.dart`.

`prism-flutter/flutter_plugin/lib/src/generated/prism_native_bindings.dart` — AUTO-GENERATED by ffigen: `PrismNativeBindings` class with 7 `dart:ffi` bound methods.

`prism-flutter/flutter_plugin/lib/src/generated/prism_js_bindings.dart` — AUTO-GENERATED by `generateDartJsBindings` task: `prismJsExportNames` const list + 35 `@JS()` external function declarations covering all prism-js exports.

`prism-flutter/flutter_plugin/lib/src/prism_engine_ffi.dart` — New `PrismEngine` FFI implementation using `PrismNativeBindings`; loads `libprism.dylib`/`.so`/`.dll` depending on platform. Provides `initialize`, `togglePause` (stub), `isInitialized`, `getState`, `shutdown`.

`prism-flutter/flutter_plugin/lib/src/prism_web_plugin.dart` — Removed 5 hand-written `@JS()` declarations; imports `generated/prism_js_bindings.dart`. Window-pinning script now iterates `prismJsExportNames` (35 functions). `PrismWebEngine` updated to use handle-based API (`prismCreateEngine` + `prismEngineInitialize` in `init()`; `prismEngineIsAlive`/`prismEngineGetDeltaTime`/`prismEngineGetTotalTime`/`prismDestroyEngine` in instance methods).

`prism-flutter/flutter_plugin/lib/src/prism_engine.dart` — Added TODO comment about wiring `prism_engine_ffi.dart` once native library bundling per-platform is solved.

`prism-flutter/flutter_plugin/lib/src/prism_web_plugin.dart` (post-fix) — Reverted `PrismWebEngine` to use high-level Flutter WASM API (`prismInit`, `prismTogglePause`, etc.). Window-pinning script now pins both the Flutter API names and all `prismJsExportNames` so the low-level handle API is also accessible to external JS.

`prism-flutter/build.gradle.kts` (post-fix) — Added `:kotlinWasmNpmInstall` (root-project task, fixed path from bare `kotlinWasmNpmInstall`) as dependency of `copyWasmToFlutterWeb` so `skiko.mjs`/`skiko.wasm` are always extracted from Gradle cache. Added copy of `prism.mjs`, `prism.uninstantiated.mjs`, `prism.wasm` from `:prism-js` build output and `prism-sdk.mjs` from `:prism-js` project directory into `flutter_plugin/example/web/`.

`prism-js/prism-sdk.mjs` — New hand-written ES module OO façade over the flat `@JsExport` API. Exports: `PrismEngine`, `PrismWorld`, `PrismScene`, `PrismMeshNode`, `PrismCameraNode`, `PrismLightNode`, `PrismEmptyNode`, `PrismMeshBuilder`.

`prism-flutter/flutter_plugin/lib/src/prism_sdk_types.dart` — New shared value types (`Vec3`, `EngineConfig`, `TransformComponent`, `Entity`) used by both web and stub Dart SDK implementations.

`prism-flutter/flutter_plugin/lib/src/prism_sdk_web.dart` — New web Dart SDK wrapper routing all calls to prism.mjs via generated `@JS()` bindings. Mirrors Kotlin API: `Engine`, `World`, `Scene`, `Node`, `MeshNode`, `CameraNode`, `LightNode`.

`prism-flutter/flutter_plugin/lib/src/prism_sdk_stub.dart` — Stub implementation that throws `UnsupportedError` on all non-web platforms; allows web-only Dart code to compile everywhere.

`prism-flutter/flutter_plugin/lib/prism_sdk.dart` — Conditional export: routes to web impl when `dart.library.js_interop` is available, stub otherwise.

`docs/index.html` (second review) — Added Kotlin and Swift import statements to snippets; fixed Swift imports from four separate module imports to single `import Prism` (baseName = "Prism" in prism-ios).

`prism-js/prism-sdk.mjs` (second review fixes) — Renamed all `PrismX` → `X` to match Kotlin API. Added `Vec3`, `EngineConfig`, `TransformComponent`. `Vec3.zero`/`Vec3.one` changed from getters (new object each access) to frozen static fields. `World.addComponent` now throws `TypeError` for unsupported component types. `Scene.activeCamera` setter now validates `instanceof CameraNode` before delegating.

`prism-flutter/flutter_plugin/lib/src/prism_sdk_web.dart` (second review fixes) — Removed duplicate `export 'prism_sdk_types.dart'` (was causing compile error — `prism_sdk.dart` already exports it). Removed unused `dart:js_interop` import. `World.addComponent` now throws `ArgumentError` for unsupported component types. Added doc comment on `Node._handle` clarifying the library-private subclassing limitation.

`prism-flutter/flutter_plugin/lib/src/prism_sdk_stub.dart` (second review fixes) — Changed `export 'prism_sdk_types.dart'` to `import` (was a duplicate export via `prism_sdk.dart`).

`prism-flutter/flutter_plugin/lib/src/prism_engine_ffi.dart` (second review fixes) — `nativeName.cast()` → `nativeName.cast<Void>()` (explicit type, matches generated binding for `void* appName`). Moved `prism_engine_initialize` and `_initialized = true` inside the `try` block; added `catch` that destroys the engine handle before rethrowing so no handle leaks if initialize fails.

`prism-flutter/flutter_plugin/example/web/.gitignore` — Gitignore for generated WASM/JS artifacts (`prism-flutter.{mjs,wasm}`, `prism.{mjs,wasm}`, `prism-sdk.mjs`, `skiko.{mjs,wasm}`).

`docs/index.html` — API section unhidden; JS snippet updated to use class-based `prism-sdk.mjs` API; all 5 code snippets made consistent (create engine → setup content → query state) and non-collapsible; architecture diagram extended with prism-js / prism-native; M12 milestone added.

`docs/style.css` — `.lang-label` always shows `border-bottom`; removed `cursor: pointer` and `details[open]` rule.

`prism-flutter/build.gradle.kts` — Added `bundleNativeMacOS` task: depends on `:prism-native:linkReleaseSharedMacosArm64`, runs `xcodebuild -create-xcframework` to wrap `libprism.dylib` into `flutter_plugin/macos/Frameworks/PrismNative.xcframework`. SPM binary targets require XCFrameworks; raw dylibs are not supported.

`prism-flutter/flutter_plugin/macos/Package.swift` — New: SPM manifest declaring `prism_flutter` Swift target (sources in `Classes/`) and `PrismNative` binary target pointing at `Frameworks/PrismNative.xcframework`. Requires macOS 13+.

`prism-flutter/flutter_plugin/macos/Classes/PrismFlutterPlugin.swift` — New: minimal `FlutterPlugin` registration stub. Imports `PrismNative` so the linker embeds the XCFramework in the app bundle. No MethodChannel — all engine calls go through Dart FFI.

`prism-flutter/flutter_plugin/macos/Frameworks/.gitignore` — New: ignores the built `PrismNative.xcframework` (generated artifact, same pattern as other build outputs).

`prism-flutter/flutter_plugin/lib/src/prism_engine_dispatch.dart` — New: runtime dispatcher using `dart:io Platform` checks; routes to `ffi.PrismEngine` on macOS/Linux/Windows and `channel.PrismEngine` on iOS/Android. Resolves the `dart.library.ffi` ambiguity (true on all native platforms).

`prism-flutter/flutter_plugin/lib/src/prism_engine.dart` — Updated export: removed stale TODO; now exports `prism_engine_dispatch.dart` for native and `prism_engine_web.dart` for web via `dart.library.js_interop` conditional.

`prism-flutter/flutter_plugin/lib/src/prism_render_view_mobile.dart` — Added macOS case returning a placeholder `Text` widget. Full render surface is future work; engine API via `PrismEngine` is usable now.

`prism-flutter/flutter_plugin/pubspec.yaml` — Added `macos: pluginClass: PrismFlutterPlugin` under `flutter.plugin.platforms`.

`prism-flutter/flutter_plugin/macos/prism_flutter/Package.swift` — Replaced `macos/Package.swift`: moved to Flutter's required path `macos/prism_flutter/Package.swift`; product name changed to `prism-flutter` (hyphen, Flutter replaces `_` with `-`); platform lowered to `.macOS(.v10_15)` to match `FlutterGeneratedPluginSwiftPackage`; XCFramework path changed to `Frameworks/PrismNative.xcframework` (self-contained within the package dir).

`prism-flutter/flutter_plugin/macos/prism_flutter/Sources/prism_flutter/PrismFlutterPlugin.swift` — Moved from `macos/Classes/`; removed `import PrismNative` (the dylib has no Swift module interface; SPM dependency is enough for embedding).

`prism-flutter/flutter_plugin/lib/src/prism_engine_ffi.dart` — Changed macOS from `DynamicLibrary.open('libprism.dylib')` to `DynamicLibrary.process()`: SPM embeds and auto-loads `libprism.dylib` via dyld before Dart runs; calling `open()` loaded a second copy causing duplicate ObjC class warnings and crashes.

`prism-flutter/build.gradle.kts` — Changed `bundleNativeiOS` from a `Copy` task (copying `PrismDemo.xcframework`) to an `Exec` task: uses `xcodebuild -create-xcframework` to build `PrismNative.xcframework` from the iosArm64 and iosSimulatorArm64 prism-native dylibs. Matches the macOS `bundleNativeMacOS` pattern.

`prism-flutter/flutter_plugin/ios/prism_flutter/Package.swift` — Replaced `PrismDemo` binary target with `PrismNative`; updated path to `Frameworks/PrismNative.xcframework`.

`prism-flutter/flutter_plugin/ios/prism_flutter/Frameworks/.gitignore` — Changed from `PrismDemo.xcframework` to `PrismNative.xcframework`.

`prism-flutter/flutter_plugin/ios/prism_flutter/Sources/prism_flutter/PrismFlutterPlugin.swift` — Replaced full OO implementation (DemoStore, MethodChannel, platform view factory) with minimal stub matching macOS: no MethodChannel, no platform view — all engine calls handled by Dart FFI.

`prism-flutter/flutter_plugin/ios/prism_flutter/Sources/prism_flutter/PrismPlatformView.swift` — DELETED: MTKView platform view using `IosDemoControllerKt.configureDemoWithGltf` is no longer needed; iOS rendering is deferred until the prism-native C API exposes surface attachment.

`prism-flutter/flutter_plugin/lib/src/prism_engine_dispatch.dart` — Simplified dispatch: was `(isMacOS || isLinux || isWindows) ? ffi : channel`; now `isAndroid ? channel : ffi`. iOS now routes to FFI (prism-native) alongside macOS/Linux/Windows.

`prism-flutter/flutter_plugin/lib/src/prism_engine_ffi.dart` — Added `fps` and `isPaused` keys with safe defaults to `getState()`: example app reads these keys and was receiving a null access error; `fps: 0.0` and `isPaused: false` are returned until the C API tracks those values.

`prism-flutter/flutter_plugin/lib/src/prism_render_view_mobile.dart` — Removed `UiKitView` branch (no platform view factory in minimal iOS plugin); replaced macOS placeholder `Text` with `AppKitView(viewType: 'engine.prism.flutter/render_view')`.

`prism-flutter/flutter_plugin/macos/prism_flutter/Sources/prism_flutter/PrismFlutterPlugin.swift` — Added `PrismMacOSPlatformViewFactory` registration so `AppKitView` gets a real `NSView`.

`prism-flutter/flutter_plugin/macos/prism_flutter/Sources/prism_flutter/PrismMacOSPlatformView.swift` — NEW: `PrismMacOSPlatformViewFactory` + `PrismMetalView` (MTKView subclass). Uses system MetalKit only — no PrismDemo, no wgpu4k dependency. Dark-blue cleared Metal viewport running at 60fps via MTKViewDelegate. Replaces the text placeholder with a live Metal render surface.

`prism-flutter/flutter_plugin/ios/prism_flutter/Package.swift` — New: SPM manifest for iOS, mirroring macOS pattern. `PrismDemo` binary target at `Frameworks/PrismDemo.xcframework`; `prism_flutter` target at `Sources/prism_flutter`; product name `prism-flutter`.

`prism-flutter/flutter_plugin/ios/prism_flutter/Frameworks/.gitignore` — New: ignores built `PrismDemo.xcframework`.

`prism-flutter/flutter_plugin/ios/prism_flutter.podspec` — Deleted: replaced by SPM.

`prism-flutter/flutter_plugin/ios/{Classes → prism_flutter/Sources/prism_flutter}/` — Moved both Swift sources to Flutter's SPM-expected path.

`prism-flutter/build.gradle.kts` — Added `bundleNativeiOS` task: depends on `:prism-demo-core:assemblePrismDemoReleaseXCFramework`, copies output to `flutter_plugin/ios/prism_flutter/Frameworks/PrismDemo.xcframework`.

`prism-flutter/flutter_plugin/lib/src/prism_engine_channel.dart` — Added no-op `initialize()` method so `prism_engine_dispatch.dart` can call it uniformly on all platforms without `NoSuchMethodError` on mobile.

`prism-flutter/flutter_plugin/example/lib/main.dart` — Added `_engine.initialize()` call in `initState()`. On mobile it is a no-op (engine starts via platform view); on macOS it starts the native FFI engine.

`prism-flutter/flutter_plugin/example/macos/` — Scaffolded via `flutter create --platforms macos .`: standard Xcode runner project, entitlements, AppInfo.xcconfig, and gitignore for ephemeral/Pods.

## Decisions

**2026-02-20 Step 1 is a no-op** — Kotlin 2.3.0 WasmJS: `@JsExport` is function-only; applying it to a class/data class yields "This annotation is not applicable to target 'class'. Applicable targets: function". The plan's Step 1 (annotate source types) was incompatible with the current compiler. Decision: use primitives-only at the boundary via the opaque-handle registry pattern, which is architecturally cleaner anyway.

**2026-02-20 prism-native depends only on prism-math + prism-core** — `prism-scene` and `prism-ecs` don't declare linuxX64/mingwX64 targets. Adding those dependencies would cause resolution failures on desktop targets. Scene/ECS operations in the C API are deferred to a follow-up.

**2026-02-20 MeshApi uses builder pattern** — `FloatArray`/`IntArray` cannot cross the WASM JS boundary ("Only external, primitive, string, and function types are supported"). Replaced `prismMeshFromArrays(vertices: FloatArray, indices: IntArray)` with an explicit builder: `prismMeshBuilderCreate` → `prismMeshBuilderAddVertexFloat`/`prismMeshBuilderAddIndex` → `prismMeshBuilderFinalize`.

**2026-02-20 generateDartJsBindings reads `.d.mts`** — The Kotlin WasmJS compiler emits `prism.d.mts` (ESM TypeScript), not `prism.d.ts`. The Gradle task was written to read `prism.d.mts`. ffigen yaml also updated to reference the correct path.

**2026-02-20 FFI conditional export deferred** — `dart.library.ffi` is `true` on all native targets including Android/iOS. We can't currently use it to select the FFI impl only on desktop. Left a TODO comment; `prism_engine_channel.dart` remains the default for all non-web native platforms.

**2026-02-20 prism_web_plugin.dart reverted to old flutter API** — Initial Step 6 update called `prismCreateEngine` (new prism-js API), but `prism-flutter.mjs` only exports the old `prismInit`/`prismTogglePause` etc. from `FlutterWasmEntry.kt`. These are two separate WASM modules. `PrismWebEngine` was reverted to the old high-level API; `prismJsExportNames` is only used for window-pinning the low-level API alongside the flutter names.

**2026-02-20 prism-sdk.mjs: OO JS façade** — The flat `@JsExport` API surface is verbose for JS consumers. Created `prism-sdk.mjs` as a hand-written ES module that wraps the handle-based API with classes (`PrismEngine`, `PrismWorld`, `PrismScene`, `PrismMeshNode`, etc.) mirroring the Kotlin class hierarchy. This is a companion file shipped with `prism.mjs` for JS users.

**2026-02-20 MeshBuilder finalize redesign** — `prismMeshBuilderFinalize` originally discarded the vertex/index data. Since arrays can't cross the WASM boundary there is no single-call mechanism to retrieve the mesh data; finalize now freezes the builder and keeps the handle alive. Callers read data back element-at-a-time via `prismMeshBuilderGetVertexAt`/`prismMeshBuilderGetIndexAt`, then call `prismMeshBuilderDestroy`.

**2026-02-20 Window-pinning switched to dynamic enumeration** — `prism_web_plugin.dart` was importing the generated `prism_js_bindings.dart` solely to get a hardcoded name list for window-pinning. Replaced with `for (const [name, value] of Object.entries(mod))` in the inline JS script, which automatically pins every exported function with no list to maintain and no generated-file dependency.

**2026-02-20 Generated files removed from git** — `prism_js_bindings.dart` and `prism_native_bindings.dart` were committed, creating a drift risk. Replaced with `generated/.gitignore` (covers `*.dart`). Regeneration steps: `./gradlew :prism-flutter:generateDartJsBindings` (JS) and `./gradlew :prism-native:generateFfiBindings` (native).

**2026-02-20 Dart SDK wrapper: conditional export pattern** — `prism_sdk.dart` uses `export … if (dart.library.js_interop) …` so web code gets the real implementation and non-web gets stubs that throw `UnsupportedError`. Both files must only `import` (not `export`) shared types since `prism_sdk.dart` already re-exports `prism_sdk_types.dart`.

**2026-02-20 Swift import is `import Prism`** — Confirmed from `prism-ios/build.gradle.kts`: `baseName = "Prism"`. The KMP iOS XCFramework exposes a single umbrella module, not separate `PrismCore`/`PrismEcs`/etc. modules. Previous docs snippet was wrong.

**2026-02-20 Vec3 statics: frozen fields not getters** — `static get zero()` returns a new object on every access, causing unexpected inequality and wasted allocations in default parameter expressions. Changed to `static zero = Object.freeze(new Vec3(0,0,0))` — allocated once at class definition time.

**2026-02-20 `addComponent` should throw on unknown types** — Silent no-op for unsupported component types masks caller bugs. Both the JS façade and the Dart web impl now throw `TypeError`/`ArgumentError` for unrecognised types. The stub already throws `UnsupportedError` for all calls so no change needed there.

**2026-02-20 `prism_create_engine` takes `void*`** — Confirmed from generated `libprism_api.h`: `prism_create_engine(void* appName, …)`. The Dart `cast()` call must be `cast<Void>()` to match; leaving it implicit would fail if the analyzer cannot infer the type from context.

**2026-02-21 macOS uses SPM binary target, not CocoaPods** — SPM binary targets require XCFrameworks; raw `.dylib` files are not accepted. `bundleNativeMacOS` wraps `libprism.dylib` via `xcodebuild -create-xcframework`. This mirrors the iOS SPM pattern already used for `Package.swift` at the repo root.

**2026-02-21 Runtime dispatch instead of compile-time conditional** — `dart.library.ffi` is `true` on all native platforms (iOS, Android, macOS, Linux, Windows). Using it as a conditional export would silently route iOS/Android to the FFI path, breaking those platforms. Solution: `prism_engine_dispatch.dart` checks `Platform.isMacOS || Platform.isLinux || Platform.isWindows` at runtime.

**2026-02-21 `_impl` typed as `dynamic`** — Both `ffi.PrismEngine` and `channel.PrismEngine` share the same method signatures but no common interface. Typed as `dynamic` for now; extracting a shared `PrismEngineInterface` abstract class is deferred to a follow-up.

**2026-02-21 Flutter SPM path convention is `{platform}/{plugin_name}/Package.swift`** — Not `{platform}/Package.swift`. Flutter derives the path as `fileSystem.path.join(path, platformDir, name)`. Initial placement at `macos/Package.swift` caused `FlutterGeneratedPluginSwiftPackage` to have no dependencies. Moving to `macos/prism_flutter/Package.swift` fixed detection.

**2026-02-21 Flutter SPM product name uses hyphens** — Flutter calls `plugin.name.replaceAll('_', '-')` when generating the `FlutterGeneratedPluginSwiftPackage` target dependency. The plugin's `Package.swift` library product must be named `prism-flutter` (not `prism_flutter`) to match.

**2026-02-21 SPM binary target path must be inside the package directory** — Symlinks in Flutter's `.packages/` ephemeral directory are not followed by SPM for path resolution. `../Frameworks/PrismNative.xcframework` (relative to `macos/prism_flutter/`) resolved to `.packages/Frameworks/` (wrong) instead of `macos/Frameworks/`. Fixed by moving `Frameworks/` inside `macos/prism_flutter/` so the path `"Frameworks/PrismNative.xcframework"` is fully self-contained.

**2026-02-21 `DynamicLibrary.open('libprism.dylib')` causes duplicate load on macOS SPM** — SPM embeds `libprism.dylib` in the app bundle and dyld auto-loads it before Dart runs. Calling `DynamicLibrary.open('libprism.dylib')` in Flutter debug mode loaded the source-path dylib a second time (DYLD_LIBRARY_PATH pointed to the build dir), causing duplicate ObjC class warnings. Fix: use `DynamicLibrary.process()` on macOS — symbols are already in the process.

**2026-02-21 channel impl needs no-op `initialize()`** — `prism_engine_dispatch.dart` calls `_impl.initialize(...)` uniformly. `channel.PrismEngine` didn't have that method, causing `NoSuchMethodError` on mobile. Added a no-op — mobile engine starts natively via the platform view, not via an explicit call.

**2026-02-21 iOS refactored to prism-native FFI** — iOS was using PrismDemo (OO Kotlin framework, MethodChannel, MTKView platform view via `IosDemoControllerKt`). User requirement: PrismDemo is demo-only code and must not be a Flutter plugin dependency. Refactored iOS to the same prism-native C API + Dart FFI architecture as macOS. Only Android remains on MethodChannel (prism-native does not target Android).

**2026-02-21 macOS Metal render surface — system MetalKit only (temporary)** — wgpu4k's macOS `actual class Surface` required a `CPointer<GLFWwindow>` for width/height; no `macosContextRenderer(view: MTKView)` existed. Initial implementation used system MetalKit only (dark-blue clear pass) to prove the AppKitView pipeline. wgpu rendering was deferred to Step 9.

**2026-02-21 wgpu4k fork: decouple macOS from desktopNativeMain** — macOS `actual class Surface` was inherited from `desktopNativeMain` which uses `glfwGetWindowSize` for dynamic dimensions. For MTKView embedding, width/height come from the view (fixed at construction). Decision: remove `macosMain.get().dependsOn(desktopNativeMain)`, give macOS its own `Surface.macos.kt` (mirrors iOS — fixed width/height), and add `context.macos.kt` with `macosContextRendererFromLayer(NativeAddress, w, h)` and a macOS-local `glfwContextRenderer`/`GLFWContext` for backward compatibility with the desktop demo.

**2026-02-21 prism_attach_metal_layer uses runBlocking** — `macosContextRendererFromLayer` is `suspend` (calls `requestAdapter`/`requestDevice`). The C API cannot be `suspend`. Solution: `runBlocking { macosContextRendererFromLayer(...) }`. In Kotlin/Native, `runBlocking` runs the coroutine synchronously on the calling thread (Swift's main thread via MTKViewDelegate). All wgpu initialisation calls complete synchronously under the hood so this is safe.

**2026-02-21 Lazy surface attachment on first draw** — Calling `prism_attach_metal_layer` at Swift `init()` time risks the CAMetalLayer not being fully configured yet (view not in hierarchy). Instead, attach lazily on the first `draw(in:)` call (MTKViewDelegate), at which point `drawableSize` is valid and the layer is ready. A `surfaceAttached` flag prevents double-attach.

**2026-02-21 AppKitView creationParams pass engineHandle as Int64** — Swift reads the engine handle from `(args as? [String: Any])?["engineHandle"] as? Int64`. Flutter encodes `int` (Dart) as `Int64` (Swift) via `FlutterStandardMessageCodec`. The handle is used to call `prism_attach_metal_layer(engineHandle, layerPtr, w, h)` and per-frame `prism_render_frame(engineHandle)`.

**2026-02-21 bundleNativeMacOS must delete old XCFramework** — `xcodebuild -create-xcframework` fails with exit code 70 if the output path already exists. Added `File(outDir, "PrismNative.xcframework").deleteRecursively()` to `doFirst` (mirrors the existing `bundleNativeiOS` task). This was the root cause of the first bundleNativeMacOS failure after the rebuild.

**2026-02-21 `getState()` safe defaults for `fps` and `isPaused`** — The C API does not track fps or pause state. The example app reads `state['fps']` and `state['isPaused']`; returning a map without those keys caused a Dart null access error at runtime. Added `'fps': 0.0` and `'isPaused': false` as explicit safe defaults until the C API exposes these values.

### Step 9 — wgpu macOS rendering (2026-02-21)

`wgpu4k-toolkit/build.gradle.kts` — Removed `macosMain.get().dependsOn(desktopNativeMain)`; added `macosMain { dependencies { api(libs.glfw.native) } }` so macOS gets GLFW for backward-compat but is no longer forced onto the GLFW-window-based `Surface`.

`wgpu4k-toolkit/src/macosMain/kotlin/Surface.macos.kt` — NEW actual class `Surface(handler, width: UInt, height: UInt)`: fixed-dimension implementation mirroring iOS, independent of GLFW.

`wgpu4k-toolkit/src/macosMain/kotlin/context.macos.kt` — NEW: `macosContextRenderer(MTKView, w, h)` (gets layer from view), `macosContextRendererFromLayer(NativeAddress, w, h)` (accepts raw layer pointer — used from C API bridge), `MacosContext(wgpuContext)`, macOS-local `glfwContextRenderer`/`GLFWContext` (mirrors desktopNativeMain for the desktop demo).

`wgpu4k-toolkit/src/macosMain/kotlin/glfw.macos.kt` — Removed `actual` keyword; function becomes a package-private extension callable by `glfwContextRenderer` in the same source set (no longer satisfies an `expect` since macOS left `desktopNativeMain`).

`prism-native/build.gradle.kts` — Added `macosMain.dependencies { implementation(libs.wgpu4k.toolkit); implementation(libs.kotlinx.coroutines.core) }`.

`prism-native/src/macosMain/kotlin/engine/prism/native/MacosBridge.kt` — NEW: three `@CName` C API functions: `prism_attach_metal_layer(handle, layerPtr, w, h)` (creates MacosContext via `runBlocking`, configures surface, starts game-loop in external mode), `prism_render_frame(handle)` (ticks game loop, submits wgpu clear-color render pass, calls `surface.present()`), `prism_detach_surface(handle)` (stops game loop, closes MacosContext).

`prism-flutter/flutter_plugin/macos/prism_flutter/Sources/prism_flutter/PrismMacOSPlatformView.swift` — Replaced manual Metal clear with prism-native C API: reads `engineHandle` from `creationParams`, lazy-attaches wgpu surface on first `draw(in:)`, forwards each frame to `prism_render_frame`, calls `prism_detach_surface` on `deinit`.

`prism-flutter/flutter_plugin/lib/src/prism_engine_ffi.dart` — Added `int get handle => _engineHandle` for platform view interop.

`prism-flutter/flutter_plugin/lib/src/prism_engine_dispatch.dart` — Added `int get handle` forwarding to `ffi.PrismEngine.handle` on FFI platforms (0 on Android).

`prism-flutter/flutter_plugin/lib/src/prism_render_view_mobile.dart` — macOS `AppKitView` now passes `creationParams: {'engineHandle': engine.handle}` so the Swift platform view can call `prism_attach_metal_layer`.

`prism-flutter/build.gradle.kts` — Fixed `bundleNativeMacOS` task: added `File(outDir, "PrismNative.xcframework").deleteRecursively()` to `doFirst` (xcodebuild fails with exit 70 if output already exists).

`gradle/libs.versions.toml` — Bumped `wgpu4kCommit` to `49da407...` (new commit on `fix/android-api35-wgpu4k-native-snapshot` branch with macOS toolkit changes). All three fork pins are now the heads of their respective branches.

## Issues

**`@JsExport` on classes fails in Kotlin 2.3.0 WasmJS** — Compiler error: "This annotation is not applicable to target 'class'. Applicable targets: function". Attempted to annotate data classes (Entity, etc.) in commonMain. Reverted all class annotations. Resolution: bridge uses primitive-only boundary with opaque handles.

**prism-native directory didn't exist before prism-js build** — Gradle failed with "Configuring project ':prism-native' without an existing directory is not allowed" when `:prism-js` was added to settings first. Resolution: created stub `prism-native/build.gradle.kts` before running the prism-js build.

**`dartOut.get().asFile` compile error in Gradle task** — `layout.projectDirectory.file(...)` returns `RegularFile` (not `Provider<RegularFile>`), so `.get()` doesn't exist. Resolution: `val dartOutFile = layout.projectDirectory.file(...).asFile` — captures a plain `java.io.File` directly and is used in `doLast`.

## Commits

5d5c2df — chore: add devlog and plan for feat/ffi-kmp-bindings (issue #40)
6593425 — feat: auto-generated JS and native bindings (prism-js + prism-native)
638c90b — fix: restore flutter web demo and add kotlinWasmNpmInstall dependency
53a5c5e — docs: show API section with prism-js/native examples, add M12 milestone
8dcd3b7 — docs: consistent non-collapsing API snippets across all 5 targets
941318a — chore: update devlog with all commits and post-fix decisions
d359142 — feat(prism-js): add OO JS façade (prism-sdk.mjs) and wire into build
576d9ef — docs: merge dart panels and align all 4 snippets to same pattern
4d63535 — docs: rename dart panel label to 'Dart · Flutter'
a2f6c6b — docs: remove prism-sdk label from JS panel
4ffb75a — fix: address all critical review findings
e3eed72 — chore: update devlog with review fixes and decisions
037bfaf — feat: add Dart SDK wrapper (prism_sdk.dart) mirroring the Kotlin API
ac535e7 — docs: add import statements to Kotlin and Swift snippets
ac535e70d63eaa2a4b3d121f7e07b9a5ac77fa33 — fix: address second critical review findings
aa95126 — feat: macOS Flutter desktop support via SPM (#828)
4acc28e — feat: scaffold macOS example runner and fix channel initialize
8119203 — docs: update Dart snippet and platform table for macOS FFI
3ce2dcb — docs: align Dart snippet structure with other three panels
87c1a83 — fix: correct SPM package structure and library loading for macOS
c02201f — feat: migrate iOS plugin from CocoaPods to SPM
5c7bdac — chore: update devlog with SPM migration decisions and fixes
e66a7a4 — feat: switch iOS to prism-native FFI and add macOS Metal platform view
5e8d0b1 — chore: update devlog
5e8d0b1 — chore: update devlog (replaced HEAD above)
HEAD — feat: generalize prism-flutter, add prism-flutter-demo, runtime fixes, test coverage (Steps 10–13)

### Step 10 — Generalize `prism-flutter` + `prism-flutter-demo` (2026-02-21)

`prism-flutter/src/commonMain/.../PrismBridge.kt` — Replaced demo-specific class with generic `open class PrismBridge<T : Any, S : Store<*, *>>(val store: S)`. Removed all demo type imports.

`prism-flutter/src/commonMain/.../FlutterMethodHandler.kt` — Replaced concrete class with `abstract class AbstractFlutterMethodHandler(bridge: PrismBridge<*, *>)`. Retained `MethodNotImplementedException`. All demo dispatch logic moved to `prism-flutter-demo`.

`prism-flutter/src/androidMain/.../PrismAndroidBridge.kt` — New generic abstract base: manages wgpu SurfaceView lifecycle, frame timing, `onSurfaceReady`/`doFrame`. Subclasses implement `createScene`/`tickScene`.

`prism-flutter/src/macosMain/.../PrismMetalBridge.kt` — New generic abstract base: full Metal surface setup, wgpu context creation, surface configuration, frame timing. Subclasses implement `createScene`/`tickScene`.

`prism-flutter/build.gradle.kts` — Stripped all `prism-demo-*` dependencies; added `androidMain` wgpu4k-toolkit `api`; changed `macosMain` wgpu4k-toolkit to `api`; removed `binaries.executable()`/`outputModuleName` from wasmJs block; updated `copyWasmToFlutterWeb` to reference `:prism-flutter-demo` build outputs.

`prism-flutter/src/wasmJsMain/.../FlutterWasmEntry.kt` — Deleted (moved to `prism-flutter-demo`).

`settings.gradle.kts` — Added `include(":prism-flutter-demo")`.

`prism-flutter-demo/build.gradle.kts` — New KMP module: all targets, SKIE, macOS `PrismFlutterDemo` framework, wasmJs with `outputModuleName = "prism-flutter"`. Depends on `prism-flutter` + `prism-demo-core`.

`prism-flutter-demo/src/commonMain/.../DemoBridge.kt` — Concrete `PrismBridge<DemoScene, DemoStore>` with `isPaused`/`dispatchFps`.

`prism-flutter-demo/src/commonMain/.../FlutterMethodHandler.kt` — Full MethodChannel dispatcher; takes `PrismBridge<DemoScene, DemoStore>`.

`prism-flutter-demo/src/androidMain/.../DemoAndroidBridge.kt` — Extends `PrismAndroidBridge` with demo scene factory/tick.

`prism-flutter-demo/src/macosMain/.../DemoMacosBridge.kt` — Extends `PrismMetalBridge` with PBR sphere-grid scene; `surfacePreConfigured = true`.

`prism-flutter-demo/src/wasmJsMain/.../FlutterWasmEntry.kt` — Moved from `prism-flutter`, package updated to `com.hyeonslab.prism.flutter.demo`.

`prism-flutter/flutter_plugin/android/.../PrismFlutterPlugin.kt` — Now creates `DemoAndroidBridge()` + `FlutterMethodHandler(bridge)` from `prism-flutter-demo`. No demo store/intent imports.

`prism-flutter/flutter_plugin/android/.../PrismPlatformView.kt` — Accepts `PrismAndroidBridge<*, *>`; zero demo imports. Delegates `onSurfaceReady`/`doFrame`/`shutdown` to bridge.

`prism-flutter/flutter_plugin/android/build.gradle` — Replaced `prism-flutter-android` + `prism-demo-core-android` with `prism-flutter-demo-android`.

`prism-flutter/flutter_plugin/macos/.../PrismMetalBridgeProtocol.swift` — New `@objc public protocol`: `attachMetalLayer`, `renderFrame`, `detachSurface`, `isInitialized`.

`prism-flutter/flutter_plugin/macos/.../PrismMacOSPlatformView.swift` — Rewritten: `PrismMacOSPlatformViewFactory` takes a `bridgeFactory: () -> PrismMetalBridgeProtocol` closure; `PrismMetalView` drives any `PrismMetalBridgeProtocol`. No more `PrismNative` C API calls or engine handles.

`prism-flutter/flutter_plugin/example/macos/Runner/AppDelegate.swift` — Imports `PrismFlutterDemo`; conforms `DemoMacosBridge: PrismMetalBridgeProtocol`; registers factory `{ DemoMacosBridge() }`.

`prism-flutter/flutter_plugin/macos/prism_flutter/Frameworks/.gitignore` — Added `PrismFlutterDemo.xcframework`.

## Decisions (Step 10)

2026-02-21 Inverted dependency direction — `prism-flutter` must have zero demo deps; `prism-flutter-demo` is the proper consumer of both `prism-flutter` and `prism-demo-core`. This fixes the library/demo layering that was inverted since Step 6.

2026-02-21 `PrismMacOSPlatformViewFactory` takes a factory closure instead of a fixed bridge type — enables any `PrismMetalBridgeProtocol` conformer to drive the view without the plugin package importing demo frameworks.

2026-02-21 `outputModuleName` stays `"prism-flutter"` in `prism-flutter-demo` wasmJs — Dart loader expects this name; changing it would require coordinating with the Flutter plugin Dart side.

### Step 11 — Post-refactor fixes (2026-02-21)

Plan: `devlog/plans/000017-02-post-refactor-fixes.md`

`prism-flutter/src/androidMain/.../PrismAndroidBridge.kt` — Made `createScene` and `onSurfaceReady` `suspend` (Fix 8: safe for GLB I/O inside scene creation). Added `open fun onDimensionsChanged(width, height)` hook (Fix 2). Added `resetFrameTiming()` to zero `lastMark` on resume and prevent multi-second delta spike (Fix 9).

`prism-flutter/src/macosMain/.../PrismMetalBridge.kt` — Added `protected open val isPaused: Boolean get() = false`. Added `if (!isPaused)` guard in `renderFrame()` so the pause mechanism matches Android (Fix 10).

`prism-flutter-demo/src/commonMain/.../DemoBridge.kt` — Added `override fun shutdown()` calling `scene?.shutdown()` then `super.shutdown()` (Fix 1). Removed `open` modifier — no subclasses exist (Fix 12).

`prism-flutter-demo/src/androidMain/.../DemoAndroidBridge.kt` — Added `glbLoader: (() -> ByteArray?)? = null` constructor param; `createScene` is now `suspend` and tries GLTF first, falls back to procedural scene (Fix 8). Added `override fun onDimensionsChanged` → `scene?.updateAspectRatio(width, height)` (Fix 2). Added FPS smoothing dispatch in `tickScene` (Fix 3). Added `override fun shutdown()` (Fix 1).

`prism-flutter-demo/src/macosMain/.../DemoMacosBridge.kt` — Changed `val isPaused` → `override val isPaused` so `PrismMetalBridge.renderFrame()` reads it (Fix 10). Removed inline `if (!isPaused)` guard from `tickScene` — guard now lives in the base (Fix 10). Added FPS smoothing dispatch in `tickScene` (Fix 3). Added `override fun shutdown()` (Fix 1).

`prism-flutter/flutter_plugin/android/.../PrismFlutterPlugin.kt` — Introduced `PrismBridgeBundle(bridge, handler)` data class. Replaced two-factory `configure(bridgeFactory, handlerFactory)` with single `configure((Context) -> PrismBridgeBundle)` so host creates typed bridge+handler in the same scope with no unchecked cast (Fix 6). Added `if (::bridge.isInitialized) bridge.shutdown()` guard in `onDetachedFromEngine` (Fix 7).

`prism-flutter/flutter_plugin/android/.../PrismPlatformView.kt` — `surfaceChanged` now calls `bridge.onDimensionsChanged(width, height)` when already initialized (Fix 2). `resumeRendering()` calls `bridge.resetFrameTiming()` before posting the Choreographer callback (Fix 9). Removed stale `@SuppressLint("ClickableViewAccessibility")` annotation and its import (Fix 11).

`prism-flutter/flutter_plugin/macos/.../PrismFlutterPlugin.swift` — Added `private static var bridgeFactory` and `static func configure(bridgeFactory:)`. `register(with:)` now reads from `bridgeFactory` and fatal-errors with a clear message if not configured. Removes the no-arg `PrismMacOSPlatformViewFactory()` call that no longer exists (Fix 4).

`prism-flutter/flutter_plugin/example/macos/Runner/AppDelegate.swift` — Removed manual `registrar.register(factory:withId:)` call that duplicated the `GeneratedPluginRegistrant` registration. Added `PrismFlutterPlugin.configure { DemoMacosBridge() }` before `super.applicationDidFinishLaunching` (Fix 5).

## Decisions (Step 11)

2026-02-21 `PrismBridgeBundle` single-factory replaces two-factory pattern — the old `handlerFactory: (PrismAndroidBridge<*, *>) -> AbstractFlutterMethodHandler` forced an unchecked cast because the concrete handler (`FlutterMethodHandler`) expects `PrismBridge<DemoScene, DemoStore>`. By moving bundle construction to the host app (which has full type info), both bridge and handler are created in a typed scope and the bundle fields upcast implicitly.

2026-02-21 `configure` receives `Context` — the `glbLoader` closure needs `context.assets.open(...)` to load GLB bytes from Flutter's asset bundle. Passing `Context` through the factory avoids storing it as a global and keeps the plugin's API surface clean.

2026-02-21 FPS smoothing lives in `tickScene` not `doFrame`/`renderFrame` — `tickScene` is already skipped when paused, so FPS is only updated when real frames are produced. This avoids a zero-fps reading during pause.

2026-02-21 `resetFrameTiming` public, not called from base — `pauseRendering` can't call it because pausing removes the frame callback before the next frame, so the timing drift only manifests on resume. Calling it in `resumeRendering` (platform view) rather than base `doFrame` keeps the bridge class free of pause-state knowledge.

### Step 12 — macOS demo runtime bug fixes (2026-02-21)

The 11 macOS-specific post-refactor fixes landed cleanly. Running the demo revealed three new crashes unrelated to the refactor:

**Bug 1 — `wgpu panicked: invalid rowsPerImage` in `WgpuRenderer.create1x1Texture`**

`TexelCopyBufferLayout(bytesPerRow = N)` leaves `rowsPerImage = null`. The Kotlin/Native mapper (`TextureDataLayout.kt`) does `input.rowsPerImage?.let { output.rowsPerImage = it }` — when null the native `WGPUTexelCopyBufferLayout.rowsPerImage` stays at its zero-initialized default of `0`. wgpu-native's `conv.rs` validation rejects `rowsPerImage = 0` (must be `COPY_STRIDE_UNDEFINED = 0xFFFFFFFF` or `>= extent.height`).

Fixed all six call sites by passing explicit `rowsPerImage`:
- `WgpuRenderer.create1x1Texture`: `rowsPerImage = 1u`
- `WgpuRenderer.createDefaultTextures` cubemap loop: `rowsPerImage = 1u`
- `WgpuRenderer.writeTextureFromArrayBuffer`: `rowsPerImage = h`
- `IblGenerator.uploadBrdfLut`: `rowsPerImage = size.toUInt()`
- `IblGenerator.uploadCubemap` per-face loop: `rowsPerImage = size.toUInt()`
- `IblGenerator.uploadPrefilteredCubemap` mip loop: `rowsPerImage = mipSize.toUInt()`

Files: `prism-renderer/src/commonMain/kotlin/com/hyeonslab/prism/renderer/WgpuRenderer.kt`, `IblGenerator.kt`.

**Bug 2 — WGSL shader parse error: truncated at multi-byte UTF-8 characters**

wgpu-native (or the Kotlin/Native cinterop bridge) truncates the WGSL source string at the first multi-byte UTF-8 character. Root cause: the `WGPUStringView.length` field is set to the Kotlin `String.length` (character count) rather than the UTF-8 byte count. For a string containing e.g. `§` (2 bytes), the GPU receives `strlen("...") = charCount` bytes, which cuts off content that comes after the first multi-byte character.

Three Unicode characters were inside WGSL shader strings:
- `§` (U+00A7, 2 bytes) in `PBR_VERTEX_SHADER` comment → WGSL string truncated at line 75 of combined PBR shader
- `→` (U+2192, 3 bytes) in `TONE_MAP_FRAGMENT_SHADER` comment → ToneMap shader truncated near end
- `→` in `PBR_FRAGMENT_SHADER` spot-light comment (same character)

Fixed by replacing all non-ASCII characters in WGSL shader source strings with ASCII equivalents:
- `§13.4.1` → `13.4.1`
- `→ fall back` → `: fall back`
- `→ sRGB gamma` → `to sRGB gamma`, `γ ≈ 2.2` → `~2.2`

File: `prism-renderer/src/commonMain/kotlin/com/hyeonslab/prism/renderer/Shaders.kt`.

After all three fixes the macOS Flutter demo launches, initializes wgpu/Metal, and renders frames without crashing.

## Issues (Step 12)

2026-02-21 `wgpu4k` cinterop `WGPUStringView.length` uses char count instead of UTF-8 byte count — any WGSL shader string containing characters with codepoints > 0x7F will be silently truncated. Workaround: keep all WGSL source strings ASCII-only. Upstream fix would be to use `encodeToByteArray().size.toULong()` for the length field.

## Decisions (Step 12)

2026-02-21 Kept `rowsPerImage = h` (height) rather than `COPY_STRIDE_UNDEFINED = 0xFFFFFFFFu` for readability — the value must be >= extent.height per spec; using the actual height is the most informative and portable choice.

2026-02-21 WGSL shader strings must be ASCII-only — added as a standing rule to prevent re-introduction of the truncation bug. Applies to all shader source string literals passed via wgpu4k Kotlin/Native cinterop.

### Step 13 — Code review fixes + test coverage (2026-02-21)

Plan: `devlog/plans/000017-03-code-review-test-coverage.md`

`prism-flutter/src/macosMain/.../PrismMetalBridge.kt` — A1: added `ctx?.close()` at the top of `attachMetalLayer` before the null-ptr guard, so a previous wgpu context is always released on re-attachment. A2: narrowed `catch (e: IllegalStateException)` in `renderFrame` to only reconfigure when message contains "Outdated" or "fail to get texture"; all other ISEs are rethrown. A4: replaced `val config = surfaceConfig ?: return` early-exit with `surfaceConfig?.let { configure }` so `onResize` is always called even when the surface has not been configured yet.

`prism-demo-core/src/macosMain/.../MacosDemoMain.kt` → `DemoMacosMain.kt` — A3: renamed file; wrapped the GLFW `while` loop in `try/finally` so `scene.shutdown()` and `surface.detach()` execute even when an unexpected exception escapes the render loop.

`prism-flutter/src/commonTest/.../PrismBridgeTest.kt` — New: B2 tests for `PrismBridge` lifecycle. Covers `isInitialized` before/after `attachScene`, `detachScene`, `shutdown`, double-shutdown, and shutdown on uninitialised bridge.

`prism-flutter-demo/src/commonTest/.../FlutterMethodHandlerTest.kt` — New: B1 tests for `FlutterMethodHandler` using a real `DemoBridge` with no scene attached. Covers all domain dispatch branches (togglePause, setRotationSpeed, setMetallic, setRoughness, setEnvIntensity), `getState` key/value verification, and `MethodNotImplementedException` for unknown methods.

`prism-flutter-demo/src/commonTest/.../FpsSmoothingTest.kt` — New: B3 tests for the EMA smoothing formula used in `DemoMacosBridge.tickScene` / `DemoAndroidBridge.tickScene`. Uses `DemoStore` directly to exercise the formula without platform binaries. Covers cold start, convergence at steady rate, zero/negative dt guard, slow-frame damping, and very-small dt spike.

`prism-flutter-demo/src/commonTest/.../DemoInputTest.kt` — New: B4 tests for zoom clamping and orbitBy sign convention. The `coerceIn(2f, 40f)` formula is extracted and tested for min/max clamp, mid-range, and boundary cases.

`prism-flutter-demo/example/test/widget_test.dart` — B5: replaced counter placeholder with three widget tests. `debugDefaultTargetPlatformOverride = TargetPlatform.iOS` prevents AppKitView/AndroidView creation (which requires a registered factory). Tests: fps chip shows "0 fps" initially; loading overlay visible before engine initialises; overlay persists when channel `isInitialized` returns false.

## Decisions (Step 13)

2026-02-21 A4 always calls `onResize` — the original guard protected against calling `surface.configure` with a null config, but also silently dropped aspect-ratio updates during the first draw. Both concerns are now independent: `surfaceConfig?.let` only reconfigures when the config exists; `onResize` is unconditionally called (its null-safe `scene?.updateAspectRatio` is already safe with no scene).

2026-02-21 B3 tests formula via DemoStore rather than tickScene directly — `tickScene` is macOsMain/androidMain and would require platform binaries in commonTest. Mirroring the EMA formula in the test exercises both the store dispatch pattern and the mathematical output without adding platform test targets.

2026-02-21 B4 orbitBy sign tests are trivial but document the contract — the sign convention (dx positive → move right) is subtle and has been a bug source before. Trivial assertions serve as living documentation of the expected sign.

2026-02-21 Dart widget test uses TargetPlatform.iOS override — prevents AppKitView (macOS) and AndroidView (Android) from being created during tests; PrismRenderView falls through to its "not yet available on this platform" Text branch, which needs no platform view factory registration.

## Commits (Step 13)

(see top-level Commits section — all steps land in one commit)

---

### Step 14 — Surface PrismFlutter.xcframework + docs fixes (2026-02-21)

`prism-flutter/build.gradle.kts` — Added SKIE plugin; added `XCFramework("PrismFlutter")` + `macosArm64 { binaries.framework { baseName = "PrismFlutter" } }`; added `bundleFlutterMacOS` Copy task that depends on `assemblePrismFlutterReleaseXCFramework` and copies the output into `flutter_plugin/macos/prism_flutter/Frameworks/PrismFlutter.xcframework`.

`prism-flutter/flutter_plugin/macos/prism_flutter/Package.swift` — Added `PrismFlutter` binary target referencing the new framework; added it as a dependency of the `prism_flutter` Swift target alongside `PrismNative`.

`prism-flutter/flutter_plugin/macos/prism_flutter/Frameworks/.gitignore` — Added `PrismFlutter.xcframework` (pre-built output, not committed).

`docs/index.html` — Platform table: corrected Flutter macOS row from `PrismFlutterDemo.xcframework` (demo-specific) to `PrismFlutter.xcframework` (generic consumer framework). Code snippets: split `scene.addNode(...); scene.activeCamera = cam` onto two lines in all four language panels (Kotlin, Swift, JS, Dart).

## Decisions (Step 14)

2026-02-21 Separate `PrismFlutter.xcframework` from `PrismFlutterDemo.xcframework` — the demo framework bundles demo-specific scene code; a consumer app should link the generic bridge (`PrismFlutter.xcframework`) and supply their own scene. This mirrors how the `PrismNative.xcframework` (C++ core) is already separated from the demo. SKIE is applied to `prism-flutter` too so that `PrismMetalBridge` exposes ObjC selectors that match `PrismMetalBridgeProtocol`.

2026-02-21 `Package.swift` now declares both `PrismNative` and `PrismFlutter` as binary targets — consumers of the `prism_flutter` Swift Package get both the C++ core and the Kotlin bridge automatically, which is the minimum set needed to subclass `PrismMetalBridge` in their own framework.

## Commits (Step 14)

71c7e02 — feat: surface PrismFlutter.xcframework and fix docs code snippets
HEAD — docs: add HEAD commit tracking rule to AGENTS.md and CONVENTIONS.md

---

### Step 15 — Critical review fixes (2026-02-21)

Plan: `devlog/plans/000017-04-critical-review-fixes.md`

`wgpu4k/wgpu4k/src/commonMain/kotlin/SurfaceOutdatedException.kt` — New: typed exception
extending `IllegalStateException` so existing catch blocks work during migration. (F7)

`wgpu4k/wgpu4k/src/commonNativeMain/kotlin/Surface.native.kt` — `getCurrentTexture()` now
reads the status before accessing the texture pointer; throws `SurfaceOutdatedException` when
`status == SurfaceTextureStatus.outdated` instead of crashing on a null texture. (F7)
Version not bumped (fork not yet published to Maven local).

`prism-flutter/src/commonMain/.../FrameTimer.kt` — New: `FrameTimer` class encapsulating
start/lastMark/frameCount; used by both `PrismMetalBridge` and `PrismAndroidBridge` to
eliminate the duplicated timing boilerplate. (M-8)

`prism-flutter/src/commonMain/.../PrismBridge.kt` — F6: `attachScene`/`detachScene` →
`internal` (callers are same-module only). m-1: `fun isInitialized(): Boolean` →
`val isInitialized: Boolean` (pure property, no side effects).

`prism-flutter/src/macosMain/.../PrismMetalBridge.kt` — F1: wrapped surface-config+scene-
creation in try-catch; closes new `MacosContext` on exception to prevent GPU resource leak.
F3: added `surfaceConfig = null` in `detachSurface()`. F10: moved `frameCount++` after
`if (isPaused) return` so the counter reflects rendered frames only. Uses `FrameTimer`.

`prism-flutter/src/androidMain/.../PrismAndroidBridge.kt` — Uses `FrameTimer`; removed
manual start/lastMark/frameCount fields.

`prism-flutter/src/commonMain/.../FlutterMethodHandler.kt` — m-1: updated
`bridge.isInitialized()` → `bridge.isInitialized`.

`prism-flutter/src/commonTest/.../PrismBridgeTest.kt` — m-1: updated all
`bridge.isInitialized()` → `bridge.isInitialized`.

`prism-flutter/src/commonTest/.../AbstractFlutterMethodHandlerTest.kt` — New: 7 tests for
`AbstractFlutterMethodHandler` dispatch contract using `FakeBridge`/`PassThroughHandler`.
Covers isInitialized before/after attach, shutdown, getState, domain forwarding, unknown
method exception, and shutdown→isInitialized regression.

`prism-flutter/flutter_plugin/macos/.../PrismMetalBridgeProtocol.swift` — m-1: updated
`func isInitialized() -> Bool` → `var isInitialized: Bool { get }`.

`prism-flutter/flutter_plugin/macos/.../PrismFlutterPlugin.swift` — F5: replaced
`fatalError` with `assertionFailure` + `return` so release builds no-op instead of crashing
when bridge is unconfigured. m-1: updated `bridge.isInitialized()` → `bridge.isInitialized`.

`prism-flutter/flutter_plugin/macos/.../PrismMacOSPlatformView.swift` — F11: `deinit`
now dispatches `detachSurface()` to the main thread via `DispatchQueue.main.async` to prevent
race with ARC deallocation on a background thread. m-1: `bridge.isInitialized()` →
`bridge.isInitialized`. m-4: corrected sensitivity comment (628 pts/revolution, not 314).

`prism-flutter/flutter_plugin/android/.../PrismPlatformView.kt` — m-1: updated
`bridge.isInitialized()` → `bridge.isInitialized`.

`prism-demo-core/src/macosMain/.../DemoMacosMain.kt` — F2: `fread` return value captured;
returns `null` on short read. F4: added `@Volatile` to `lastMouseX`, `lastMouseY`,
`mouseButtonDown` + explanatory comment about GLFW's synchronous dispatch model.

`prism-flutter-demo/src/macosMain/.../DemoMacosBridge.kt` — F2: `fread` return value
captured; returns `null` + warning log on short read. F8: `shutdown()` now joins all
background-scope children via `runBlocking` before cancelling, so in-flight texture
uploads complete before `scene.shutdown()` tears down GPU state.

`prism-flutter-demo/src/androidMain/.../DemoAndroidBridge.kt` — F8: same shutdown-order
fix as DemoMacosBridge.

`prism-flutter-demo/src/commonMain/.../FlutterMethodHandler.kt` — m-2: `setRotationSpeed`
now throws `IllegalArgumentException` when `args["speed"]` is absent (previously silently
defaulted to 45f).

`prism-flutter-demo/src/commonMain/.../DemoBridge.kt` — m-3: removed public `dispatchFps()`
dead-code method (FPS is dispatched inline in `tickScene`).

`prism-flutter-demo/src/commonTest/.../FlutterMethodHandlerTest.kt` — Updated for m-1
(`bridge.isInitialized`) and m-2 (test now expects `IllegalArgumentException` on missing
speed arg, not a default value).

## Decisions (Step 15)

2026-02-21 wgpu4k version not bumped — fork not yet published to Maven local; the
`SurfaceOutdatedException` class is added to the fork but Prism's catch blocks still use
the string-matching ISE check until the fork is published (F7 Prism-side deferred to Phase B).

2026-02-21 F9 (getState routing) deferred to Phase B — requires Swift protocol changes and
SKIE export adjustments; isolated from Phase A fixes. Implemented in the follow-up commit.

2026-02-21 FrameTimer `nextFrame` vs Android frameCount semantics — macOS (post F10): calls
`nextFrame()` only when not paused, so `frameCount` is a rendered-frame counter. Android:
calls `nextFrame()` unconditionally before the `if (!isPaused)` guard, preserving the
pre-existing behavior (deemed non-buggy per the review).

## Commits (Step 15)

adf657f — fix: critical review fixes (F1-F12, new test, wgpu4k SurfaceOutdatedException)

### Step 16 — F9: getState routing through Kotlin (2026-02-21)

`prism-flutter/src/macosMain/.../PrismMetalBridge.kt` — Added `open fun getState(): Map<String, Any>`
with a base implementation returning `{initialized}`. Concrete bridges override to add
domain fields.

`prism-flutter-demo/src/macosMain/.../DemoMacosBridge.kt` — Overrides `getState()` to
return the full demo state: `{initialized, isPaused, fps, rotationSpeed, metallic, roughness,
envIntensity}` — matching Kotlin's `FlutterMethodHandler.getState()` used on Android.

`prism-flutter/flutter_plugin/macos/.../PrismMetalBridgeProtocol.swift` — Added
`func getState() -> [String: Any]` requirement.

`prism-flutter/flutter_plugin/macos/.../PrismFlutterPlugin.swift` — Replaced the three-field
inline map (`fps`, `isPaused`, `initialized`) with `bridge.getState() as NSDictionary` so all
fields are now populated from Kotlin.

## Decisions (Step 16)

2026-02-21 `bridge.getState() as NSDictionary` — SKIE maps `Map<String, Any>` to a type
that bridges to `NSDictionary`, which `FlutterStandardMessageCodec` encodes correctly for
the Dart method channel. The cast is safe since the values (Double, Bool) are NSNumber.

2026-02-21 `open fun getState()` on base class rather than abstract — future non-demo bridges
get a working default (initialized only) without being forced to implement domain-specific fields.

## Commits (Step 16)

ad1f24c — fix(F9): route getState through Kotlin; macOS+Android getState now return same fields
