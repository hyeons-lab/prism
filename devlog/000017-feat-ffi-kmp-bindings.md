# 000017 — feat/ffi-kmp-bindings

**Agent:** Claude Code (claude-sonnet-4-6) @ hyeons-lab/prism branch feat/ffi-kmp-bindings
**Intent:** Implement auto-generated JS and native bindings for Prism (issue #40) — `prism-js` module (WASM/TypeScript SDK) and `prism-native` module (Kotlin/Native C API), with ffigen-based Dart FFI bindings and auto-generated Dart `@JS()` bindings.

## Progress

- [x] Step 1 — Annotate clean types with `@JsExport` (effectively a no-op — see Decisions)
- [x] Step 2 — Create `prism-js` module (WASM/TypeScript SDK)
- [x] Step 3 — Create `prism-native` module (Kotlin/Native C API)
- [x] Step 4 — Wire Dart FFI bindings via ffigen
- [x] Step 5 — Auto-generate Dart `@JS()` bindings from `.d.mts`
- [x] Step 6 — Update `prism-flutter` to use generated bindings

## What Changed

`settings.gradle.kts` — Added `include(":prism-js")` and `include(":prism-native")` to the include list.

`prism-js/build.gradle.kts` — New module: wasmJs target with `generateTypeScriptDefinitions()`, depends on prism-math, prism-core, prism-scene, prism-ecs.

`prism-js/src/wasmJsMain/kotlin/engine/prism/js/Registry.kt` — String-keyed opaque handle registry; Kotlin objects stay Kotlin-side and are referenced by String IDs across the WASM JS boundary.

`prism-js/src/wasmJsMain/kotlin/engine/prism/js/EngineApi.kt` — `@JsExport` bridge functions for engine lifecycle: `prismCreateEngine`, `prismEngineInitialize`, `prismEngineIsAlive`, `prismEngineGetDeltaTime`, `prismEngineGetTotalTime`, `prismDestroyEngine`.

`prism-js/src/wasmJsMain/kotlin/engine/prism/js/SceneApi.kt` — `@JsExport` bridge functions for scene/node management: create/destroy scene, create/add/destroy nodes, set position/rotation/scale, set active camera.

`prism-js/src/wasmJsMain/kotlin/engine/prism/js/EcsApi.kt` — `@JsExport` bridge functions for ECS world: create world, create/destroy entities, add transform component, get transform X/Y/Z.

`prism-js/src/wasmJsMain/kotlin/engine/prism/js/MeshApi.kt` — `@JsExport` builder-pattern mesh API: create builder, add vertex floats and indices one-at-a-time, finalize into mesh ID. (Arrays cannot cross the WASM JS boundary — see Issues.)

`prism-native/build.gradle.kts` — New module: iosArm64, iosSimulatorArm64, macosArm64, linuxX64, mingwX64 targets; each with `sharedLib { baseName = "prism" }`. Depends on prism-math and prism-core only (prism-scene/prism-ecs lack desktop targets). Includes `generateFfiBindings` task that calls `dart run ffigen`.

`prism-native/src/nativeMain/kotlin/engine/prism/native/Registry.kt` — Long-keyed opaque handle registry for the C API.

`prism-native/src/nativeMain/kotlin/engine/prism/native/NativeBridge.kt` — `@CName`-annotated functions exporting 7 C symbols: `prism_create_engine`, `prism_engine_initialize`, `prism_engine_is_alive`, `prism_engine_get_delta_time`, `prism_engine_get_total_time`, `prism_engine_get_frame_count`, `prism_destroy_engine`.

`prism-flutter/build.gradle.kts` — Added `generateDartJsBindings` task: reads `prism.d.mts` from prism-js build output and emits `prism_js_bindings.dart` with `@JS()` declarations and `prismJsExportNames` list.

`prism-flutter/flutter_plugin/pubspec.yaml` — Added `ffi: ^2.1.0` dep, `ffigen: ^13.0.0` dev dep; added `ffiPlugin: true` and macOS/Linux/Windows platform entries under `flutter.plugin.platforms`.

`prism-flutter/flutter_plugin/ffigen.yaml` — ffigen config: reads `libprism_api.h` from prism-native macosArm64 debug build, includes only `prism_.*` functions, outputs to `lib/src/generated/prism_native_bindings.dart`.

`prism-flutter/flutter_plugin/lib/src/generated/prism_native_bindings.dart` — AUTO-GENERATED by ffigen: `PrismNativeBindings` class with 7 `dart:ffi` bound methods.

`prism-flutter/flutter_plugin/lib/src/generated/prism_js_bindings.dart` — AUTO-GENERATED by `generateDartJsBindings` task: `prismJsExportNames` const list + 35 `@JS()` external function declarations covering all prism-js exports.

`prism-flutter/flutter_plugin/lib/src/prism_engine_ffi.dart` — New `PrismEngine` FFI implementation using `PrismNativeBindings`; loads `libprism.dylib`/`.so`/`.dll` depending on platform. Provides `initialize`, `togglePause` (stub), `isInitialized`, `getState`, `shutdown`.

`prism-flutter/flutter_plugin/lib/src/prism_web_plugin.dart` — Removed 5 hand-written `@JS()` declarations; imports `generated/prism_js_bindings.dart`. Window-pinning script now iterates `prismJsExportNames` (35 functions). `PrismWebEngine` updated to use handle-based API (`prismCreateEngine` + `prismEngineInitialize` in `init()`; `prismEngineIsAlive`/`prismEngineGetDeltaTime`/`prismEngineGetTotalTime`/`prismDestroyEngine` in instance methods).

`prism-flutter/flutter_plugin/lib/src/prism_engine.dart` — Added TODO comment about wiring `prism_engine_ffi.dart` once native library bundling per-platform is solved.

`prism-flutter/flutter_plugin/lib/src/prism_web_plugin.dart` (post-fix) — Reverted `PrismWebEngine` to use high-level Flutter WASM API (`prismInit`, `prismTogglePause`, etc.). Window-pinning script now pins both the Flutter API names and all `prismJsExportNames` so the low-level handle API is also accessible to external JS.

`prism-flutter/build.gradle.kts` (post-fix) — Added `:kotlinWasmNpmInstall` (root-project task, fixed path from bare `kotlinWasmNpmInstall`) as dependency of `copyWasmToFlutterWeb` so `skiko.mjs`/`skiko.wasm` are always extracted from Gradle cache. Added copy of `prism.mjs`, `prism.uninstantiated.mjs`, `prism.wasm` from `:prism-js` build output and `prism-sdk.mjs` from `:prism-js` project directory into `flutter_plugin/example/web/`.

`prism-js/prism-sdk.mjs` — New hand-written ES module OO façade over the flat `@JsExport` API. Exports: `PrismEngine`, `PrismWorld`, `PrismScene`, `PrismMeshNode`, `PrismCameraNode`, `PrismLightNode`, `PrismEmptyNode`, `PrismMeshBuilder`.

`prism-flutter/flutter_plugin/example/web/.gitignore` — Gitignore for generated WASM/JS artifacts (`prism-flutter.{mjs,wasm}`, `prism.{mjs,wasm}`, `prism-sdk.mjs`, `skiko.{mjs,wasm}`).

`docs/index.html` — API section unhidden; JS snippet updated to use class-based `prism-sdk.mjs` API; all 5 code snippets made consistent (create engine → setup content → query state) and non-collapsible; architecture diagram extended with prism-js / prism-native; M12 milestone added.

`docs/style.css` — `.lang-label` always shows `border-bottom`; removed `cursor: pointer` and `details[open]` rule.

## Decisions

**2026-02-20 Step 1 is a no-op** — Kotlin 2.3.0 WasmJS: `@JsExport` is function-only; applying it to a class/data class yields "This annotation is not applicable to target 'class'. Applicable targets: function". The plan's Step 1 (annotate source types) was incompatible with the current compiler. Decision: use primitives-only at the boundary via the opaque-handle registry pattern, which is architecturally cleaner anyway.

**2026-02-20 prism-native depends only on prism-math + prism-core** — `prism-scene` and `prism-ecs` don't declare linuxX64/mingwX64 targets. Adding those dependencies would cause resolution failures on desktop targets. Scene/ECS operations in the C API are deferred to a follow-up.

**2026-02-20 MeshApi uses builder pattern** — `FloatArray`/`IntArray` cannot cross the WASM JS boundary ("Only external, primitive, string, and function types are supported"). Replaced `prismMeshFromArrays(vertices: FloatArray, indices: IntArray)` with an explicit builder: `prismMeshBuilderCreate` → `prismMeshBuilderAddVertexFloat`/`prismMeshBuilderAddIndex` → `prismMeshBuilderFinalize`.

**2026-02-20 generateDartJsBindings reads `.d.mts`** — The Kotlin WasmJS compiler emits `prism.d.mts` (ESM TypeScript), not `prism.d.ts`. The Gradle task was written to read `prism.d.mts`. ffigen yaml also updated to reference the correct path.

**2026-02-20 FFI conditional export deferred** — `dart.library.ffi` is `true` on all native targets including Android/iOS. We can't currently use it to select the FFI impl only on desktop. Left a TODO comment; `prism_engine_channel.dart` remains the default for all non-web native platforms.

**2026-02-20 prism_web_plugin.dart reverted to old flutter API** — Initial Step 6 update called `prismCreateEngine` (new prism-js API), but `prism-flutter.mjs` only exports the old `prismInit`/`prismTogglePause` etc. from `FlutterWasmEntry.kt`. These are two separate WASM modules. `PrismWebEngine` was reverted to the old high-level API; `prismJsExportNames` is only used for window-pinning the low-level API alongside the flutter names.

**2026-02-20 prism-sdk.mjs: OO JS façade** — The flat `@JsExport` API surface is verbose for JS consumers. Created `prism-sdk.mjs` as a hand-written ES module that wraps the handle-based API with classes (`PrismEngine`, `PrismWorld`, `PrismScene`, `PrismMeshNode`, etc.) mirroring the Kotlin class hierarchy. This is a companion file shipped with `prism.mjs` for JS users.

**2026-02-20 MeshBuilder finalize redesign** — `prismMeshBuilderFinalize` originally discarded the vertex/index data. Since arrays can't cross the WASM boundary there is no single-call mechanism to retrieve the mesh data; finalize now freezes the builder and keeps the handle alive. Callers read data back element-at-a-time via `prismMeshBuilderGetVertexAt`/`prismMeshBuilderGetIndexAt`, then call `prismMeshBuilderDestroy`.

**2026-02-20 Window-pinning switched to dynamic enumeration** — `prism_web_plugin.dart` was importing the generated `prism_js_bindings.dart` solely to get a hardcoded name list for window-pinning. Replaced with `for (const [name, value] of Object.entries(mod))` in the inline JS script, which automatically pins every exported function with no list to maintain and no generated-file dependency.

**2026-02-20 Generated files removed from git** — `prism_js_bindings.dart` and `prism_native_bindings.dart` were committed, creating a drift risk. Replaced with `generated/.gitignore` (covers `*.dart`). Regeneration steps: `./gradlew :prism-flutter:generateDartJsBindings` (JS) and `./gradlew :prism-native:generateFfiBindings` (native).

## Issues

**`@JsExport` on classes fails in Kotlin 2.3.0 WasmJS** — Compiler error: "This annotation is not applicable to target 'class'. Applicable targets: function". Attempted to annotate data classes (Entity, etc.) in commonMain. Reverted all class annotations. Resolution: bridge uses primitive-only boundary with opaque handles.

**prism-native directory didn't exist before prism-js build** — Gradle failed with "Configuring project ':prism-native' without an existing directory is not allowed" when `:prism-js` was added to settings first. Resolution: created stub `prism-native/build.gradle.kts` before running the prism-js build.

**`dartOut.get().asFile` compile error in Gradle task** — `layout.projectDirectory.file(...)` returns `RegularFile` (not `Provider<RegularFile>`), so `.get()` doesn't exist. Resolution: `val dartOutFile = layout.projectDirectory.file(...).asFile` — captures a plain `java.io.File` directly and is used in `doLast`.

## Commits

5d5c2df — chore: add devlog and plan for feat/ffi-kmp-bindings (issue #40)
6593425 — feat: auto-generated JS and native bindings (prism-js + prism-native)
638c90b — fix: restore flutter web demo and add kotlinWasmNpmInstall dependency
53a5c5e — docs: show API section with prism-js/native examples, add M12 milestone
8dcd3b7 — docs: consistent non-collapsing API snippets across all 5 targets
941318a — chore: update devlog with all commits and post-fix decisions
d359142 — feat(prism-js): add OO JS façade (prism-sdk.mjs) and wire into build
576d9ef — docs: merge dart panels and align all 4 snippets to same pattern
4d63535 — docs: rename dart panel label to 'Dart · Flutter'
a2f6c6b — docs: remove prism-sdk label from JS panel
HEAD — fix: address all critical review findings
