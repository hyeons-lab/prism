# 000017 — feat/ffi-kmp-bindings

**Agent:** Claude Code (claude-sonnet-4-6) @ hyeons-lab/prism branch feat/ffi-kmp-bindings
**Intent:** Implement auto-generated JS and native bindings for Prism (issue #40) — `prism-js` module (WASM/TypeScript SDK) and `prism-native` module (Kotlin/Native C API), with ffigen-based Dart FFI bindings and auto-generated Dart `@JS()` bindings.

## Progress

- [x] Step 1 — Annotate clean types with `@JsExport` (effectively a no-op — see Decisions)
- [x] Step 2 — Create `prism-js` module (WASM/TypeScript SDK)
- [x] Step 3 — Create `prism-native` module (Kotlin/Native C API)
- [x] Step 4 — Wire Dart FFI bindings via ffigen
- [x] Step 5 — Auto-generate Dart `@JS()` bindings from `.d.mts`
- [x] Step 6 — Update `prism-flutter` to use generated bindings

## What Changed

`settings.gradle.kts` — Added `include(":prism-js")` and `include(":prism-native")` to the include list.

`prism-js/build.gradle.kts` — New module: wasmJs target with `generateTypeScriptDefinitions()`, depends on prism-math, prism-core, prism-scene, prism-ecs.

`prism-js/src/wasmJsMain/kotlin/engine/prism/js/Registry.kt` — String-keyed opaque handle registry; Kotlin objects stay Kotlin-side and are referenced by String IDs across the WASM JS boundary.

`prism-js/src/wasmJsMain/kotlin/engine/prism/js/EngineApi.kt` — `@JsExport` bridge functions for engine lifecycle: `prismCreateEngine`, `prismEngineInitialize`, `prismEngineIsAlive`, `prismEngineGetDeltaTime`, `prismEngineGetTotalTime`, `prismDestroyEngine`.

`prism-js/src/wasmJsMain/kotlin/engine/prism/js/SceneApi.kt` — `@JsExport` bridge functions for scene/node management: create/destroy scene, create/add/destroy nodes, set position/rotation/scale, set active camera.

`prism-js/src/wasmJsMain/kotlin/engine/prism/js/EcsApi.kt` — `@JsExport` bridge functions for ECS world: create world, create/destroy entities, add transform component, get transform X/Y/Z.

`prism-js/src/wasmJsMain/kotlin/engine/prism/js/MeshApi.kt` — `@JsExport` builder-pattern mesh API: create builder, add vertex floats and indices one-at-a-time, finalize into mesh ID. (Arrays cannot cross the WASM JS boundary — see Issues.)

`prism-native/build.gradle.kts` — New module: iosArm64, iosSimulatorArm64, macosArm64, linuxX64, mingwX64 targets; each with `sharedLib { baseName = "prism" }`. Depends on prism-math and prism-core only (prism-scene/prism-ecs lack desktop targets). Includes `generateFfiBindings` task that calls `dart run ffigen`.

`prism-native/src/nativeMain/kotlin/engine/prism/native/Registry.kt` — Long-keyed opaque handle registry for the C API.

`prism-native/src/nativeMain/kotlin/engine/prism/native/NativeBridge.kt` — `@CName`-annotated functions exporting 7 C symbols: `prism_create_engine`, `prism_engine_initialize`, `prism_engine_is_alive`, `prism_engine_get_delta_time`, `prism_engine_get_total_time`, `prism_engine_get_frame_count`, `prism_destroy_engine`.

`prism-flutter/build.gradle.kts` — Added `generateDartJsBindings` task: reads `prism.d.mts` from prism-js build output and emits `prism_js_bindings.dart` with `@JS()` declarations and `prismJsExportNames` list.

`prism-flutter/flutter_plugin/pubspec.yaml` — Added `ffi: ^2.1.0` dep, `ffigen: ^13.0.0` dev dep; added `ffiPlugin: true` and macOS/Linux/Windows platform entries under `flutter.plugin.platforms`.

`prism-flutter/flutter_plugin/ffigen.yaml` — ffigen config: reads `libprism_api.h` from prism-native macosArm64 debug build, includes only `prism_.*` functions, outputs to `lib/src/generated/prism_native_bindings.dart`.

`prism-flutter/flutter_plugin/lib/src/generated/prism_native_bindings.dart` — AUTO-GENERATED by ffigen: `PrismNativeBindings` class with 7 `dart:ffi` bound methods.

`prism-flutter/flutter_plugin/lib/src/generated/prism_js_bindings.dart` — AUTO-GENERATED by `generateDartJsBindings` task: `prismJsExportNames` const list + 35 `@JS()` external function declarations covering all prism-js exports.

`prism-flutter/flutter_plugin/lib/src/prism_engine_ffi.dart` — New `PrismEngine` FFI implementation using `PrismNativeBindings`; loads `libprism.dylib`/`.so`/`.dll` depending on platform. Provides `initialize`, `togglePause` (stub), `isInitialized`, `getState`, `shutdown`.

`prism-flutter/flutter_plugin/lib/src/prism_web_plugin.dart` — Removed 5 hand-written `@JS()` declarations; imports `generated/prism_js_bindings.dart`. Window-pinning script now iterates `prismJsExportNames` (35 functions). `PrismWebEngine` updated to use handle-based API (`prismCreateEngine` + `prismEngineInitialize` in `init()`; `prismEngineIsAlive`/`prismEngineGetDeltaTime`/`prismEngineGetTotalTime`/`prismDestroyEngine` in instance methods).

`prism-flutter/flutter_plugin/lib/src/prism_engine.dart` — Added TODO comment about wiring `prism_engine_ffi.dart` once native library bundling per-platform is solved.

## Decisions

**2026-02-20 Step 1 is a no-op** — Kotlin 2.3.0 WasmJS: `@JsExport` is function-only; applying it to a class/data class yields "This annotation is not applicable to target 'class'. Applicable targets: function". The plan's Step 1 (annotate source types) was incompatible with the current compiler. Decision: use primitives-only at the boundary via the opaque-handle registry pattern, which is architecturally cleaner anyway.

**2026-02-20 prism-native depends only on prism-math + prism-core** — `prism-scene` and `prism-ecs` don't declare linuxX64/mingwX64 targets. Adding those dependencies would cause resolution failures on desktop targets. Scene/ECS operations in the C API are deferred to a follow-up.

**2026-02-20 MeshApi uses builder pattern** — `FloatArray`/`IntArray` cannot cross the WASM JS boundary ("Only external, primitive, string, and function types are supported"). Replaced `prismMeshFromArrays(vertices: FloatArray, indices: IntArray)` with an explicit builder: `prismMeshBuilderCreate` → `prismMeshBuilderAddVertexFloat`/`prismMeshBuilderAddIndex` → `prismMeshBuilderFinalize`.

**2026-02-20 generateDartJsBindings reads `.d.mts`** — The Kotlin WasmJS compiler emits `prism.d.mts` (ESM TypeScript), not `prism.d.ts`. The Gradle task was written to read `prism.d.mts`. ffigen yaml also updated to reference the correct path.

**2026-02-20 FFI conditional export deferred** — `dart.library.ffi` is `true` on all native targets including Android/iOS. We can't currently use it to select the FFI impl only on desktop. Left a TODO comment; `prism_engine_channel.dart` remains the default for all non-web native platforms.

## Issues

**`@JsExport` on classes fails in Kotlin 2.3.0 WasmJS** — Compiler error: "This annotation is not applicable to target 'class'. Applicable targets: function". Attempted to annotate data classes (Entity, etc.) in commonMain. Reverted all class annotations. Resolution: bridge uses primitive-only boundary with opaque handles.

**prism-native directory didn't exist before prism-js build** — Gradle failed with "Configuring project ':prism-native' without an existing directory is not allowed" when `:prism-js` was added to settings first. Resolution: created stub `prism-native/build.gradle.kts` before running the prism-js build.

**`dartOut.get().asFile` compile error in Gradle task** — `layout.projectDirectory.file(...)` returns `RegularFile` (not `Provider<RegularFile>`), so `.get()` doesn't exist. Resolution: `val dartOutFile = layout.projectDirectory.file(...).asFile` — captures a plain `java.io.File` directly and is used in `doLast`.

## Commits

5d5c2df — chore: add devlog and plan for feat/ffi-kmp-bindings (issue #40)
HEAD — feat: auto-generated JS and native bindings (prism-js + prism-native)
