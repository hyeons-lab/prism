# Session — 2026-02-14 (Build System + WgpuRenderer)

## Agent
**Claude Code** (claude-sonnet-4-5-20250929 → claude-opus-4-6) @ `prism` branch `main`

## Model Switches
- **[2026-02-14 10:50 PST]** Sonnet 4.5 → Opus 4.6 — Switched for more capable implementation work on WgpuRenderer

## Intent
Complete Phase 1 (build system setup) and begin Phase 2 (WgpuRenderer implementation). Get wgpu4k integrated and compiling, then implement the core WgpuRenderer class.

## What Changed

### Build System (Phase 1)

- **[2026-02-14 10:50 PST]** `gradle.properties` — Added KMP properties (`enableCInteropCommonization`, `ignoreDisabledTargets`, `experimental.macos.enabled`)
- **[2026-02-14 10:51 PST]** `settings.gradle.kts` — Fixed `dependencyResolutionManagement`, added `mavenLocal()` for locally-built wgpu4k
- **[2026-02-14 10:52 PST]** `gradle/libs.versions.toml` — Added wgpu4k 0.2.0-SNAPSHOT and wgpu4k-toolkit dependencies
- **[2026-02-14 10:53 PST]** `prism-renderer/build.gradle.kts` — Added wgpu4k + wgpu4k-toolkit deps, `-Xexpect-actual-classes` flag
- **[2026-02-14 10:54 PST]** `prism-core/build.gradle.kts` — Added `-Xexpect-actual-classes` compiler flag

### Compilation Fixes

- **[2026-02-14 10:58 PST]** `prism-core/.../Engine.kt` — Changed `subsystems` from `private` to `@PublishedApi internal` for inline function access
- **[2026-02-14 10:59 PST]** `prism-core/.../Platform.wasmJs.kt` — Fixed `js()` call (top-level function, `@OptIn(ExperimentalWasmJsInterop)`)
- **[2026-02-14 11:00 PST]** `prism-core/.../Platform.macos.kt` — Created macOS Native Platform actual (NSDate-based)
- **[2026-02-14 11:01 PST]** `prism-core/.../Platform.linux.kt` — Created Linux Native Platform actual (gettimeofday, `@OptIn(ExperimentalForeignApi)`)
- **[2026-02-14 11:02 PST]** `prism-core/.../Platform.mingw.kt` — Created Windows Native Platform actual (GetSystemTimeAsFileTime)
- **[2026-02-14 11:03 PST]** `prism-renderer/.../RenderSurface.{macos,linux,mingw}.kt` — Created native RenderSurface stubs

### WgpuRenderer (Phase 2)

- **[2026-02-14 11:10 PST]** `prism-renderer/.../WgpuRenderer.kt` — Created full Renderer implementation using wgpu4k
  - Maps Prism types to wgpu4k types (BufferUsage, VertexFormat, Topology, CullMode, TextureFormat)
  - Uses `WGPUContext` for device/surface access
  - Handles depth texture creation and resize
  - Uses `ArrayBuffer.of()` for GPU buffer uploads
  - Resolves name collisions via import aliases

### Plan Updates

- **[2026-02-14 11:15 PST]** `PLAN.md` — Added Android and iOS as target platforms, PanamaPort for Android FFI, milestone targets M6-M8

## Decisions

- **[2026-02-14 10:52 PST]** **wgpu4k from source** — Built 0.2.0-SNAPSHOT from source to Maven local; 0.1.1 from Maven Central had different API structure
- **[2026-02-14 10:55 PST]** **Package is `io.ygdrasil.webgpu`** — Not `io.ygdrasil.wgpu` as initially assumed
- **[2026-02-14 11:10 PST]** **Import aliases for name collisions** — `import ... as WGPUColor` etc. to avoid clashes with Prism types
- **[2026-02-14 11:00 PST]** **`@PublishedApi internal` pattern** — Needed for Engine.subsystems to support inline reified function
- **[2026-02-14 11:12 PST]** **`close()` not `destroy()`** — wgpu4k uses AutoCloseable pattern

## Research & Discoveries

- **wgpu4k** — Kotlin Multiplatform WebGPU bindings
  - Repo: https://github.com/AnomalousEngine/wgpu4k (formerly ygdrasil-io/wgpu4k)
  - API docs: types live in `io.ygdrasil.webgpu` package (not `io.ygdrasil.wgpu`)
  - Built from source at `/tmp/wgpu4k` → published 0.2.0-SNAPSHOT to Maven local
  - Key patterns: `WGPUContext` wraps device + adapter + surface + renderingContext; `.bind()` within `AutoClosableContext` for resource lifecycle; `ArrayBuffer.of(floatArray)` for GPU buffer uploads
  - Enum style: PascalCase (`GPULoadOp.Clear`, `GPUStoreOp.Store`)
- **PanamaPort** — enables Project Panama FFI on Android 8.0+
  - Repo: https://github.com/AnomalousEngine/PanamaPort (fork used by wgpu4k)
  - Original: https://github.com/nicholasgasior/PanamaPort
- **WebGPU spec** — https://www.w3.org/TR/webgpu/ (wgpu4k mirrors this API)
- **WGSL spec** — https://www.w3.org/TR/WGSL/ (shader language reference)

## Issues

- wgpu4k 0.2.0.b1 not available on Maven Central or JitPack — resolved by building from source
- Gradle daemon OOM when publishing all wgpu4k modules — resolved with `--no-daemon` and increased heap
- Other modules (prism-ecs, prism-assets, prism-native-widgets) still have compilation errors — deferred

## Next Steps

- Phase 3: Create WGSL shader source strings (Shaders.kt)
- Phase 4: Platform-specific RenderSurface implementations (GLFW for JVM)
- Fix remaining module compilation errors
- Update AGENTS.md with wgpu4k version change (0.1.1 → 0.2.0-SNAPSHOT)
