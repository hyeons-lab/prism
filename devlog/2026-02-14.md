# 2026-02-14

## Session 1 — Project Scaffolding (10:00 PST, sonnet-4-5)

**Agent:** Claude Code (claude-sonnet-4-5-20250929) @ `prism` branch `main`

### Intent
Establish structured guidance for Claude Code when working with the Prism engine codebase, and create a lightweight session tracking system (devlog) for recoverability and context preservation.

### What Changed
- **[2026-02-14 10:05 PST]** `AGENTS.md` — Created comprehensive project guidance document covering architecture, build commands, KMP conventions, code quality standards, tech stack, and contribution guidelines
- **[2026-02-14 10:15 PST]** `CLAUDE.md` — Created top-level instructions file referencing AGENTS.md
- **[2026-02-14 10:36 PST]** `devlog/README.md` — Created devlog conventions
- **[2026-02-14 10:42 PST]** `AGENTS.md` — Added Session Logs section with devlog requirements and timestamp format
- **[2026-02-14 11:15 PST]** `AGENTS.md` — Added guideline to log failed attempts and lessons learned
- **[2026-02-14 11:30 PST]** `.gitignore` — Added build artifacts (.kotlin/, kotlin-js-store/)
- **[2026-02-14 11:40 PST]** `AGENTS.md` — Enhanced "Update as you go" guideline to emphasize proactive devlog updates

### Decisions
- **[2026-02-14 10:30 PST]** **Use `devlog/` not `.devlog/`** — Visible and version-controlled, not hidden
- **[2026-02-14 10:35 PST]** **Git-tracked logs** — Part of repo history, not ephemeral
- **[2026-02-14 10:48 PST]** **Include timezone in timestamps** — `[YYYY-MM-DD HH:MM TZ]` format for cross-timezone tracking
- **[2026-02-14 11:15 PST]** **Log failures and lessons learned** — Document failed attempts to prevent repeating mistakes
- **[2026-02-14 11:40 PST]** **Proactive devlog updates** — Update automatically as work progresses, not on user request

### Research & Discoveries
- **KMP references used:**
  - expect/actual pattern: https://kotlinlang.org/docs/multiplatform-expect-actual.html
  - Source set structure: https://kotlinlang.org/docs/multiplatform-discover-project.html
  - Inline function visibility rules: https://kotlinlang.org/docs/inline-functions.html#restrictions-for-public-api-inline-functions

### Commits
- `634b171` — docs: add project documentation and session tracking system
- `13af90f` — chore: add build artifacts to .gitignore and update devlog
- `ab2f818` — docs: emphasize proactive devlog updates in AGENTS.md

---

## Session 2 — Build System + WgpuRenderer (10:50 PST, sonnet-4-5 → opus-4-6)

**Agent:** Claude Code (claude-sonnet-4-5-20250929 → claude-opus-4-6) @ `prism` branch `main`
**Model switch:** Sonnet 4.5 → Opus 4.6 for more capable implementation work on WgpuRenderer

### Intent
Complete Phase 1 (build system setup) and begin Phase 2 (WgpuRenderer implementation). Get wgpu4k integrated and compiling, then implement the core WgpuRenderer class.

### What Changed

#### Build System (Phase 1)
- **[2026-02-14 10:50 PST]** `gradle.properties` — Added KMP properties (`enableCInteropCommonization`, `ignoreDisabledTargets`, `experimental.macos.enabled`)
- **[2026-02-14 10:51 PST]** `settings.gradle.kts` — Fixed `dependencyResolutionManagement`, added `mavenLocal()` for locally-built wgpu4k
- **[2026-02-14 10:52 PST]** `gradle/libs.versions.toml` — Added wgpu4k 0.2.0-SNAPSHOT and wgpu4k-toolkit dependencies
- **[2026-02-14 10:53 PST]** `prism-renderer/build.gradle.kts` — Added wgpu4k + wgpu4k-toolkit deps, `-Xexpect-actual-classes` flag
- **[2026-02-14 10:54 PST]** `prism-core/build.gradle.kts` — Added `-Xexpect-actual-classes` compiler flag

#### Compilation Fixes
- **[2026-02-14 10:58 PST]** `prism-core/.../Engine.kt` — Changed `subsystems` from `private` to `@PublishedApi internal` for inline function access
- **[2026-02-14 10:59 PST]** `prism-core/.../Platform.wasmJs.kt` — Fixed `js()` call (top-level function, `@OptIn(ExperimentalWasmJsInterop)`)
- **[2026-02-14 11:00 PST]** `prism-core/.../Platform.{macos,linux,mingw}.kt` — Created native Platform actual implementations
- **[2026-02-14 11:03 PST]** `prism-renderer/.../RenderSurface.{macos,linux,mingw}.kt` — Created native RenderSurface stubs

#### WgpuRenderer (Phase 2)
- **[2026-02-14 11:10 PST]** `prism-renderer/.../WgpuRenderer.kt` — Created full Renderer implementation using wgpu4k (type mapping, WGPUContext, depth texture, ArrayBuffer uploads, import aliases)
- **[2026-02-14 11:15 PST]** `PLAN.md` — Added Android and iOS as target platforms, PanamaPort for Android FFI

### Decisions
- **[2026-02-14 10:52 PST]** **wgpu4k from source** — Built 0.2.0-SNAPSHOT from source to Maven local; 0.1.1 from Maven Central had different API structure
- **[2026-02-14 10:55 PST]** **Package is `io.ygdrasil.webgpu`** — Not `io.ygdrasil.wgpu` as initially assumed
- **[2026-02-14 11:10 PST]** **Import aliases for name collisions** — `import ... as WGPUColor` etc. to avoid clashes with Prism types
- **[2026-02-14 11:00 PST]** **`@PublishedApi internal` pattern** — Needed for Engine.subsystems to support inline reified function
- **[2026-02-14 11:12 PST]** **`close()` not `destroy()`** — wgpu4k uses AutoCloseable pattern

### Research & Discoveries
- **wgpu4k** — Kotlin Multiplatform WebGPU bindings
  - Repo: https://github.com/AnomalousEngine/wgpu4k (formerly ygdrasil-io/wgpu4k)
  - API docs: types live in `io.ygdrasil.webgpu` package (not `io.ygdrasil.wgpu`)
  - Key patterns: `WGPUContext` wraps device + adapter + surface + renderingContext; `.bind()` within `AutoClosableContext` for resource lifecycle; `ArrayBuffer.of(floatArray)` for GPU buffer uploads
  - Enum style: PascalCase (`GPULoadOp.Clear`, `GPUStoreOp.Store`)
- **PanamaPort** — enables Project Panama FFI on Android 8.0+
  - Repo: https://github.com/AnomalousEngine/PanamaPort
- **WebGPU spec** — https://www.w3.org/TR/webgpu/
- **WGSL spec** — https://www.w3.org/TR/WGSL/

### Issues
- wgpu4k 0.2.0.b1 not available on Maven Central or JitPack — resolved by building from source
- Gradle daemon OOM when publishing all wgpu4k modules — resolved with `--no-daemon` and increased heap

### Commits
- `8b873e1` — feat: implement WgpuRenderer with native platform support

---

## Session 3 — M1/M2 Rotating Cube on JVM Desktop (14:00 PST, opus-4-6)

**Agent:** Claude Code (claude-opus-4-6) @ `prism` branch `main`

### Intent
Get a rotating cube rendering in a GLFW window on JVM/macOS — completing milestones M1 (uniform buffers, bind groups, surface present) and M2 (GLFW demo with rotating cube).

### What Changed
- **[2026-02-14 14:00 PST]** `prism-{ecs,assets,native-widgets}/build.gradle.kts` — Added `-Xexpect-actual-classes` compiler flag
- **[2026-02-14 14:05 PST]** `prism-math/.../Mat4.kt` — Fixed `perspective()` and `orthographic()` Z-mapping from OpenGL [-1,1] to WebGPU [0,1] clip space
- **[2026-02-14 14:10 PST]** `prism-renderer/.../Shaders.kt` — WGSL shader sources with vertex + fragment shaders. Uniform layout: group(0) binding(0) Uniforms (VP + model, 128 bytes), group(0) binding(1) MaterialUniforms (baseColor, 16 bytes)
- **[2026-02-14 14:20 PST]** `prism-renderer/.../WgpuRenderer.kt` — Added uniform buffer (128 bytes: VP + model), material uniform buffer (16 bytes), bind group, surface.present()
- **[2026-02-14 14:20 PST]** `prism-renderer/.../Renderer.kt` — Added `setMaterialColor(color: Color)` default method
- **[2026-02-14 14:25 PST]** `prism-demo/build.gradle.kts` — Changed mainClass to `GlfwMainKt`, added wgpu4k deps, JVM args, `jvmToolchain(25)`
- **[2026-02-14 14:30 PST]** `prism-demo/.../GlfwMain.kt` — GLFW windowed demo using raw wgpu4k API. 800x600 window, rotating cube at 45 deg/sec with directional lighting
- **[2026-02-14 14:35 PST]** `prism-ecs/.../World.kt` — Changed `entities` from `private` to `@PublishedApi internal`
- **[2026-02-14 14:35 PST]** `prism-demo/.../DemoApp.kt` — Fixed FQN conflict with `engine` property name

### Decisions
- **[2026-02-14 14:00 PST]** **Direct GLFW for M2** — Simpler than Compose for initial demo
- **[2026-02-14 14:15 PST]** **Uniform buffer layout** — 128 bytes: VP mat4 at offset 0, model mat4 at offset 64. Material color in separate 16-byte buffer
- **[2026-02-14 14:15 PST]** **Bind group from auto-derived layout** — Using `renderPipeline.getBindGroupLayout(0u)`
- **[2026-02-14 16:30 PST]** **JVM toolchain 25 required** — wgpu4k inline functions compiled at JVM target 25

### Research & Discoveries
- **wgpu4k JVM toolchain requirement**: wgpu4k 0.2.0-SNAPSHOT is compiled with JVM target 25. Any module using wgpu4k inline functions must also target JVM 25. Without this, the native FFI layer silently malfunctions.
- **`ffi.LibraryLoader.load()`** must be called explicitly before any wgpu API usage on JVM
- **wgpu4k render loop**: `autoClosableContext { }` per frame, `.bind()` on ephemeral resources, `surface.present()` after the context block
- **Surface configuration**: `glfwContextRenderer()` does NOT configure the surface. Must call `surface.configure()` separately.

### Issues
- **[RESOLVED] `invalid texture` panic** — JVM target mismatch. Fix: `jvmToolchain(25)` in prism-demo
- **[RESOLVED] `UnsatisfiedLinkError: wgpuCreateInstance`** — Native library not auto-loaded. Fix: `LibraryLoader.load()`
- **[RESOLVED] `UnsupportedClassVersionError`** — Gradle JavaExec using JDK 21. Fix: Java 25 toolchain launcher
- **[OPEN] KtFmt not working** — Plugin declared in root but not applied to subprojects. Deferred.

### Result
**M1 and M2 milestones COMPLETE.** Running `./gradlew :prism-demo:jvmRun` opens an 800x600 GLFW window with a rotating blue cube with directional lighting.

### Commits
- `a3b2fb4` — build: add JVM toolchain 25 to prism-demo module

---

## Session 4 — Critical Review + Fixes (11:45 PST, sonnet-4-5 → opus-4-6)

**Agent:** Claude Code (claude-sonnet-4-5-20250929 → claude-opus-4-6) @ `prism` branch `main`
**Model switch:** Sonnet 4.5 → Opus 4.6 for addressing review issues

### Intent
Perform a critical review of all changes made in this branch, then fix the identified issues.

### Review Summary
6 commits, 33 files, 1,805 insertions reviewed. Found 4 critical issues, 3 major issues, 3 minor issues. See full review details below.

### What Changed (Fixes)
- **[2026-02-14 11:50 PST]** `.gitignore` — Changed `*.dylib` to specific `**/libWGPU*.{dylib,so,dll}` patterns
- **[2026-02-14 11:52 PST]** `AGENTS.md` — Added "wgpu4k Setup" section with build instructions, license info (Apache 2.0), verification steps
- **[2026-02-14 11:54 PST]** `Platform.linux.kt` — Added `check(result == 0)` for gettimeofday; replaced star imports with explicit imports
- **[2026-02-14 11:54 PST]** `Platform.mingw.kt` — Added `0xFFFFFFFFL` mask to prevent sign-extension in FILETIME conversion; explicit imports
- **[2026-02-14 11:55 PST]** `BUILD_STATUS.md` — Rewrote to reflect reality: all 11 modules compile successfully
- **[2026-02-14 12:10 PST]** Consolidated devlog from 4 files per day to 1 file per day format; updated AGENTS.md and README.md conventions

### Decisions
- **[2026-02-14 11:50 PST]** **Specific dylib patterns over wildcard** — `**/libWGPU*.dylib` instead of `*.dylib`
- **[2026-02-14 11:54 PST]** **Skip macOS Platform error handling** — NSDate().timeIntervalSince1970 always returns valid; no error path
- **[2026-02-14 11:54 PST]** **Add bitmask to Windows FILETIME** — `toLong()` on `UInt` can sign-extend; mask with `0xFFFFFFFFL`
- **[2026-02-14 11:55 PST]** **All modules already fixed** — BUILD_STATUS.md was outdated; all had flags applied
- **[2026-02-14 12:05 PST]** **One file per day for devlog** — Replaced `YYYY-MM-DD_sequence.md` with `YYYY-MM-DD.md` using `## Session N` headers within. Reduces file proliferation (4 files today → 1) while preserving session boundaries.

### Issues
- **BUILD_STATUS.md was stale** — Listed 8 modules as broken when they all compiled fine. Lesson: always verify by running the actual build.

### Critical Review Findings

**Critical (fixed):**
1. `.gitignore` too broad (`*.dylib`) — fixed to specific patterns
2. Missing wgpu4k documentation — added setup section to AGENTS.md
3. No error handling in native Platform code — added checks
4. BUILD_STATUS.md outdated — rewritten

**Major (tracked):**
5. WgpuRenderer.kt has 446 lines without tests
6. RenderSurface native stubs are empty TODOs
7. No CI/CD configuration

**Minor (addressed):**
8. Devlog file proliferation — fixed by consolidating to one-file-per-day
9. JVM toolchain 25 may cause onboarding friction — documented in AGENTS.md
10. No THIRD_PARTY_LICENSES.md — tracked for future

### Commits
- `59619b4` — fix: address critical review issues

---

## Next Steps
- [ ] Add CI configuration (GitHub Actions)
- [ ] Test WgpuRenderer on macOS
- [ ] Add unit tests for renderer
- [ ] Complete native RenderSurface implementations
- [ ] Wire up KtFmt to subprojects
- [ ] Consider Compose Desktop integration for M4
