# Session — 2026-02-14 (M1/M2 Rotating Cube on JVM Desktop)

## Agent
**Claude Code** (claude-opus-4-6) @ `prism` branch `main`

## Intent
Get a rotating cube rendering in a GLFW window on JVM/macOS — completing milestones M1 (uniform buffers, bind groups, surface present) and M2 (GLFW demo with rotating cube). Builds on Phase 2 (WgpuRenderer core) from session `2026-02-14_02`.

## What Changed

### Build System Fixes
- **[2026-02-14 14:00 PST]** `prism-ecs/build.gradle.kts` — Added `-Xexpect-actual-classes` compiler flag
- **[2026-02-14 14:00 PST]** `prism-assets/build.gradle.kts` — Added `-Xexpect-actual-classes` compiler flag
- **[2026-02-14 14:00 PST]** `prism-native-widgets/build.gradle.kts` — Added `-Xexpect-actual-classes` compiler flag

### Math Fixes
- **[2026-02-14 14:05 PST]** `prism-math/.../Mat4.kt` — Fixed `perspective()` and `orthographic()` Z-mapping from OpenGL [-1,1] to WebGPU [0,1] clip space.

### New Files
- **[2026-02-14 14:10 PST]** `prism-renderer/.../Shaders.kt` — WGSL shader sources with vertex + fragment shaders. Uniform layout: group(0) binding(0) Uniforms (VP + model, 128 bytes), group(0) binding(1) MaterialUniforms (baseColor, 16 bytes).
- **[2026-02-14 14:30 PST]** `prism-demo/.../GlfwMain.kt` — GLFW windowed demo using raw wgpu4k API. 800x600 window, rotating cube at 45 deg/sec with directional lighting and cornflower blue background.

### Renderer Enhancements
- **[2026-02-14 14:20 PST]** `prism-renderer/.../WgpuRenderer.kt` — Added uniform buffer (128 bytes: VP + model), material uniform buffer (16 bytes), bind group, surface.present().
- **[2026-02-14 14:20 PST]** `prism-renderer/.../Renderer.kt` — Added `setMaterialColor(color: Color)` default method.

### Demo Build Config
- **[2026-02-14 14:25 PST]** `prism-demo/build.gradle.kts` — Changed mainClass to `GlfwMainKt`, added wgpu4k deps, JVM args, and **`jvmToolchain(25)`** (required for wgpu4k inline function compatibility).

### Pre-existing Bug Fixes
- **[2026-02-14 14:35 PST]** `prism-ecs/.../World.kt` — Changed `entities` from `private` to `@PublishedApi internal`.
- **[2026-02-14 14:35 PST]** `prism-demo/.../DemoApp.kt` — Fixed FQN conflict with `engine` property name.

## Decisions

- **[2026-02-14 14:00 PST]** **Direct GLFW for M2** — Simpler than Compose for initial demo.
- **[2026-02-14 14:15 PST]** **Uniform buffer layout** — 128 bytes: VP mat4 at offset 0, model mat4 at offset 64. Material color in separate 16-byte buffer.
- **[2026-02-14 14:15 PST]** **Bind group from auto-derived layout** — Using `renderPipeline.getBindGroupLayout(0u)`.
- **[2026-02-14 16:30 PST]** **JVM toolchain 25 required** — wgpu4k inline functions compiled at JVM target 25. Setting `jvmToolchain(25)` on prism-demo fixed the "invalid texture" crash.

## Research & Discoveries

- **wgpu4k JVM toolchain requirement**: wgpu4k 0.2.0-SNAPSHOT is compiled with JVM target 25. Any module using wgpu4k inline functions (like `autoClosableContext`) must also target JVM 25. Without this, the native FFI layer silently malfunctions, causing `wgpuTextureCreateView` to panic with "invalid texture".
- **`ffi.LibraryLoader.load()`** must be called explicitly before any wgpu API usage on JVM. The native library doesn't auto-load.
- **wgpu4k render loop pattern**: Use `autoClosableContext { }` per frame, `.bind()` on ephemeral resources (texture views, encoders, command buffers), `surface.present()` after the context block.
- **Surface configuration**: `glfwContextRenderer()` does NOT configure the surface. Must call `surface.configure(SurfaceConfiguration(...))` separately before rendering.

## Issues

- **[RESOLVED] `invalid texture` panic** — Root cause: JVM target mismatch. prism-demo was compiling at JVM 21 (default) while wgpu4k inline functions were compiled at JVM 25. The inlined bytecode wasn't executing correctly, causing native wgpu to receive invalid texture handles. Fix: `jvmToolchain(25)` in prism-demo build.gradle.kts.
- **[RESOLVED] `UnsatisfiedLinkError: wgpuCreateInstance`** — Native library not auto-loaded. Fix: added `LibraryLoader.load()` call in GlfwMain.kt.
- **[RESOLVED] `UnsupportedClassVersionError`** — Gradle JavaExec task was using JDK 21. Fix: added Java 25 toolchain launcher for `tasks.withType<JavaExec>`.
- **KtFmt not working** — Plugin declared in root but not applied to subprojects. Deferred.

## Result

**M1 and M2 milestones COMPLETE.** Running `./gradlew :prism-demo:jvmRun` opens an 800x600 GLFW window with a rotating blue cube on a cornflower blue background with directional lighting. No crashes, stable render loop.

## Next Steps

- Wire up KtFmt to subprojects
- Consider Compose Desktop integration for M4
- Refactor GlfwMain to use WgpuRenderer abstraction (currently uses raw wgpu4k API)
