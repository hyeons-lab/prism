# Session — 2026-02-14 (M1/M2 Rotating Cube on JVM Desktop)

## Agent
**Claude Code** (claude-opus-4-6) @ `prism` branch `main`

## Intent
Get a rotating cube rendering in a GLFW window on JVM/macOS — completing milestones M1 (uniform buffers, bind groups, surface present) and M2 (GLFW demo with rotating cube). Builds on Phase 2 (WgpuRenderer core) from session `2026-02-14_02`.

## What Changed

### Build System Fixes
- **[2026-02-14 14:00 PST]** `prism-ecs/build.gradle.kts` — Added `-Xexpect-actual-classes` compiler flag
- **[2026-02-14 14:00 PST]** `prism-assets/build.gradle.kts` — Added `-Xexpect-actual-classes` compiler flag
- **[2026-02-14 14:00 PST]** `prism-native-widgets/build.gradle.kts` — Added `-Xexpect-actual-classes` compiler flag

### Math Fixes
- **[2026-02-14 14:05 PST]** `prism-math/.../Mat4.kt` — Fixed `perspective()` and `orthographic()` Z-mapping from OpenGL [-1,1] to WebGPU [0,1] clip space. perspective: `-(far+near)/range` → `-far/range`, `-(2*far*near)/range` → `-(far*near)/range`. orthographic: `-2/fn` → `-1/fn`, `-(far+near)/fn` → `-near/fn`.

### New Files
- **[2026-02-14 14:10 PST]** `prism-renderer/.../Shaders.kt` — WGSL shader sources with vertex + fragment shaders. Uniform layout: group(0) binding(0) for Uniforms (VP + model mat4x4, 128 bytes), group(0) binding(1) for MaterialUniforms (baseColor vec4, 16 bytes). Vertex shader transforms by VP*M, passes world normal + UV. Fragment shader does directional light with material baseColor.
- **[2026-02-14 14:30 PST]** `prism-demo/.../GlfwMain.kt` — GLFW windowed demo entry point using wgpu4k-toolkit. Creates 800x600 window, configures surface, sets up camera/pipeline/cube, runs render loop with rotating cube at 45 deg/sec.

### Renderer Enhancements
- **[2026-02-14 14:20 PST]** `prism-renderer/.../WgpuRenderer.kt` — Added uniform buffer (128 bytes: VP + model matrices), material uniform buffer (16 bytes: baseColor), bind group creation from pipeline auto-derived layout. `initialize()` creates buffers with default white color. `setCamera()` writes VP matrix at offset 0. `drawMesh()` writes model matrix at offset 64. `bindPipeline()` creates and binds bind group. `endFrame()` now calls `surface.present()`. `shutdown()` cleans up new buffers.
- **[2026-02-14 14:20 PST]** `prism-renderer/.../Renderer.kt` — Added `setMaterialColor(color: Color)` with default empty impl.

### Demo Build Config
- **[2026-02-14 14:25 PST]** `prism-demo/build.gradle.kts` — Changed mainClass to `GlfwMainKt`, added wgpu4k + wgpu4k-toolkit + kotlinx-coroutines JVM deps. Added `JavaExec` task config with `-XstartOnFirstThread` (macOS), `--add-opens`, `--enable-native-access`.

### Pre-existing Bug Fixes
- **[2026-02-14 14:35 PST]** `prism-ecs/.../World.kt` — Changed `entities` from `private` to `@PublishedApi internal` for inline reified function access (same pattern as Engine.kt fix from previous session).
- **[2026-02-14 14:35 PST]** `prism-demo/.../DemoApp.kt` — Fixed fully-qualified `engine.prism.math.MathUtils.toRadians()` reference that conflicted with `engine` property name. Added explicit import + used `MathUtils.toRadians()`.

## Decisions

- **[2026-02-14 14:00 PST]** **Direct GLFW for M2** — Simpler than Compose integration for initial demo. Compose will be M4+ scope.
- **[2026-02-14 14:15 PST]** **Uniform buffer layout** — 128 bytes total: VP mat4 at offset 0, model mat4 at offset 64. Material color in separate 16-byte buffer. Matches WGSL std140 alignment.
- **[2026-02-14 14:15 PST]** **Bind group from auto-derived layout** — Using `renderPipeline.getBindGroupLayout(0u)` instead of explicit layout creation. Sufficient for M2.
- **[2026-02-14 14:25 PST]** **Skip LibraryLoader.load()** — wgpu4k-native is a transitive dep of wgpu4k; native libs should load automatically. If not, we'll add it later.
- **[2026-02-14 14:30 PST]** **Surface configure before rendering** — Following wgpu4k Application.kt pattern: must call `surface.configure(SurfaceConfiguration(...))` before first frame.

## Research & Discoveries

- **wgpu4k bind group API** (from ~/development/wgpu4k source):
  - `BindGroupDescriptor`, `BindGroupEntry`, `BufferBinding` are in `io.ygdrasil.webgpu` (from webgpu-ktypes-descriptors 0.0.9)
  - `device.createBindGroup(descriptor)` returns `GPUBindGroup`
  - `renderPipeline.getBindGroupLayout(index: UInt)` returns auto-derived layout
  - `renderPass.setBindGroup(index, bindGroup)` — `dynamicOffsetsData` param has implicit default
- **wgpu4k surface lifecycle** (from ~/development/wgpu4k/wgpu4k-toolkit):
  - `glfwContextRenderer()` creates window hidden (`GLFW_VISIBLE = GLFW_FALSE`)
  - Must call `glfwShowWindow()` after setup
  - Must call `surface.configure(SurfaceConfiguration(device, format, usage, alphaMode))` before rendering
  - Must call `surface.present()` after `queue.submit()` each frame
- **JVM args for wgpu4k** (from examples/glfw/build.gradle.kts):
  - macOS: `-XstartOnFirstThread` required for GLFW
  - `--add-opens=java.base/java.lang=ALL-UNNAMED` for FFI access
  - `--enable-native-access=ALL-UNNAMED` for native access
  - Java 25 toolchain used in wgpu4k examples
- **KtFmt not yet wired** — Plugin is in root build.gradle.kts but not applied to subprojects. `ktfmtFormat` task not available.

## Issues

- **KtFmt not working** — `ktfmtFormat` task not found. Plugin declared in root but not applied. Deferred to future session.
- **Pre-existing ECS inline visibility bug** — Fixed World.kt `entities` to `@PublishedApi internal` (same as Engine.kt pattern).
- **Pre-existing DemoApp.kt FQN bug** — Fixed conflicting `engine.prism.math.MathUtils` fully-qualified reference.

## Next Steps

- Run `./gradlew :prism-demo:run` to test the actual GLFW window rendering
- If native library loading fails, add explicit `wgpu4k-native` dependency or `LibraryLoader.load()` call
- Wire up KtFmt to subprojects so `ktfmtFormat` works
- Consider Compose Desktop integration for M4
